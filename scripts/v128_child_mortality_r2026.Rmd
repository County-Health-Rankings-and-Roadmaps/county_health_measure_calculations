---
title: "v128 Child Mortality - Rankings 2026"
output: html_document
author: ganhua lu; updated by how for 2026  
date: 
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# Basic information 
## Description: 
Number of deaths among residents under age 20 per 100,000 population.

##  Data Source: 
National Center for Health Statistics - Mortality Files; Census Population Estimates Program

## Numerator: 
The numerator is the number of deaths occurring before the age of 20.

## Denominator: 
The denominator is the total population under the age of 20.

## Raw data access

- NCHS mortality and natality data 2020-2023: the data is requested

- Census population estimates 2020-2023 from:
https://www2.census.gov/programs-surveys/popest/datasets



# import packages

```{r}
library(tidyverse)
library(haven)
```

# set up directory

```{r}
# set up directory that holds data needed for calculations
# NCHS mortality data, not allowed to share in GitHub
nchs_mort_dir <- "D:/CHRR/mortality raw"

# NCHS natality data, not allowed to share in GitHub
nchs_nata_dir <- "D:/CHRR/natality raw"

# Census county population estimates data
census_pop_dir <- "D:/CHRR/pop raw"
```

# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r }
fips <-  bind_rows(
  read_sas("../inputs/county_fips_with_ct_old.sas7bdat"),
  read_sas( "../inputs/state_fips.sas7bdat")) %>% 
  arrange(statecode, countycode) %>% 
  glimpse()

```

# helpers

## functions used commonly by NCHS measures

- some commonly used functions are in a separate file, `nchs_measure_helpers.R`. 
```{r}
source("../scripts/nchs_measure_helpers.R")
```

# pop data: from Census pop estimates

## function to get tot pop - children only 

```{r}
get_census_tot_pop <- function(census_ct_estimates, year_num = 13, long = TRUE) {
  
  print(paste0("YEAR: ", year_num))
  
  # county pop: census pop estimates
  ct_pop <- census_ct_estimates %>% 
    # choose year, age groups
    filter(year == year_num, agegrp %in% c(1,2,3,4))  %>% 
    # select columns for single races
    select(statecode = state, countycode = county, agegrp, pop = tot_pop)%>% 
    # fix counties
    mutate(countycode = case_when(
      statecode=='46' & countycode =='113' ~ '102',
      statecode=='51' & countycode =='515' ~ '019',
      statecode=='02' & countycode =='270' ~ '158',
      statecode=='02' & countycode =='201' ~ '198',
      TRUE ~ countycode
    )) 
  
  
   # state pop
  st_pop <- ct_pop %>% 
    group_by(statecode) %>% 
    summarise(across(c(pop), ~sum(., na.rm = TRUE)), .groups = "drop") %>% 
    mutate(countycode = "000", .after = 1)
  
  # us pop
  us_pop <- ct_pop %>% 
    summarise(across(c(pop), ~sum(., na.rm = TRUE)), .groups = "drop") %>% 
    mutate(statecode = "00", countycode = "000", .before = 1)
  
  
  
  
  ## county + state + us data
  pop_all <- bind_rows(
    us_pop, 
    st_pop, 
    ct_pop) %>% 
    arrange(statecode, countycode)
  
  
}
```

## function to process pop data for v128

```{r}
process_pop_v128 <- function(year){
  
  pop <- read_census_pop(file_name = get_census_csv_file_info(year)$file_name ) %>% 
    get_census_tot_pop(., year_num = get_census_csv_file_info(year)$year_num)
  
  return(pop)
}
```


## 2020-2023 Census pop
# children only 

```{r}

pop_all <- bind_rows(
  process_pop_v128(2020),  
  process_pop_v128(2021),
  process_pop_v128(2022) %>% 
        fix_CT_pop(process_pop_v128(2021)),
  process_pop_v128(2023) %>% 
        fix_CT_pop(process_pop_v128(2021))) %>% 
  group_by(statecode, countycode) %>%
  summarise(pop = sum(pop), .groups = "drop") %>% 
  # remove 02261
  filter(!(statecode == "02" & countycode == "261")) %>%
  glimpse()

# identical(pop_all, pop_all_2)
```


## function to process one-year mort data for v128

```{r}
get_child_mort <- function(nchs_mort, df_fips){
  mort_1 <- nchs_mort %>% 
      # include only 50 states + DC
    filter(state_of_residence %in% c(state.abb, "DC")) %>% 
    filter(age %in% c("01", "02", "03", "04", "05", "06", "07", "08", "09")) %>% 
    rename(state = state_of_residence, countycode = county_of_residence) %>% 
    # fix county FIPS codes
    mutate(countycode = case_when(
      state =='SD' & countycode =='113' ~'102',
      state =='AK' & countycode =='270' ~'158',
      state =='VA' & countycode =='515' ~'019',
      # state =='AK' & countycode =='063' ~'261',
      # state =='AK' & countycode =='066' ~'261',
      TRUE ~ countycode
      )
    )
  
  
  
  # county
  mort_ct <- mort_1 %>% 
    group_by(state, countycode) %>% 
    summarise(deaths = n(), .groups = "drop")
  
  # state
  mort_st <- mort_1 %>% 
    group_by(state) %>% 
    summarise(countycode = "000", deaths = n(), .groups = "drop") 
  
  # us
  mort_us <- mort_1 %>% 
    summarise(state = "US", countycode = "000", deaths = n())
  
  mort_all <- bind_rows(mort_ct, mort_st, mort_us) %>% 
    arrange(state, countycode) %>% 
    # add statecode
    left_join(df_fips %>% select(state, statecode) %>% 
                distinct(),
              by = c("state")) %>% 
    ungroup() %>% 
    select(-state) %>% 
    select(statecode, everything()) %>% 
    arrange(statecode, countycode) 
  
  return(mort_all)
  
}
```

## function to process mortality data for v128

```{r}
process_mort_v128 <- function(year){
  
  print(get_mort_file_name(year))
  
  mort <- read_mort_data(
    file_path = file.path(nchs_mort_dir, get_mort_file_name(year) ), 
    header = mort_header,
    n_max = Inf) %>% 
    get_child_mort(df_fips=fips)
  
  return(mort)
}
```


## mort 4 years: use map

-   fewer lines, same results as from processing one by one

```{r eval=FALSE}
mort_all <- c(2020:2023) %>% 
  map(process_mort_v128) %>% 
  list_rbind() %>% 
  group_by(statecode, countycode) %>% 
  summarise(deaths = sum(deaths), .groups = "drop") %>% 
  # filter(age_cat != 99) %>% 
  glimpse()

```









# mortality calculation

## merge mort and pop data

```{r}
merged <- pop_all %>% 
  left_join(mort_all, 
            by = c("statecode", "countycode")) %>% 
  # # replace NA with 0 for deaths
  # mutate(deaths = if_else(is.na(deaths), 0, deaths)) %>% 
  glimpse()
  
```

## confidence Intervals

```{r}
v128 <- merged %>%
  rename(numerator = deaths, denominator = pop) %>%
  mutate(
    rawvalue = numerator / denominator *100000,
    rse = 100 * sqrt(1/numerator),
  ) %>%
  mutate(
    std = rawvalue * rse / 100,
    cilow = rawvalue - 1.96 * std,
    cihigh = rawvalue + 1.96 * std
  ) %>%
  select(-c(rse, std)) %>% 
  glimpse()

```

## calculate CI L and U

```{r}
df_ci <- get_pois_CI()

```

```{r}
suppress_limit <- 10

v128_2 <- v128 %>% 
  left_join(df_ci, by = c("numerator" = "n")) %>% 
  mutate(cilow = if_else(numerator>= suppress_limit & numerator <=99,
                         rawvalue * L, cilow),
         cihigh = if_else(numerator>=suppress_limit & numerator <=99,
                         rawvalue * U, cihigh)) %>% 
  # mutate(v001_sourceflag = NA_real_) %>% 
  select(-c(L, U)) %>% 
  rename(v128_numerator = numerator, 
         v128_denominator = denominator,
         v128_rawvalue = rawvalue, 
         v128_cilow = cilow, 
         v128_cihigh= cihigh) %>% 
  mutate(across(starts_with("v"), ~ as.double(.x))) %>% 
  mutate(sourceflag  = NA_real_) 



```



# add flag_CT

```{r}
v128_2 <- v128_2 %>%
  add_flag_CT(vnum="v128", old = "U", new = "A")

```

# compare initial and duplicated calculations

```{r}
compare("v128", v128_2, 2026)
```


# save data
```{r}
save_data(v128_2, "v128")
```

