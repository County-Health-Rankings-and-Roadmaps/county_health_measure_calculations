---
title: "v051, v052, v053, v057 - R2025"
author: "GL"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# about

## Basic information

v051, Population
v052, % Below 18 Years of Age
v053, % 65 and Older
v057, % Female

## Raw data access

- Website to downloaded data

`cc-est2023-agesex-all.csv`

https://www2.census.gov/programs-surveys/popest/datasets/2020-2023

- Online documentation

https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2020-2023/CC-EST2023-AGESEX.pdf

# import packages

```{r}
library(tidyverse)
library(haven)

```

# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r }
fips <-  bind_rows(
  read_sas("../inputs/county_fips_with_ct_old.sas7bdat") ,
  read_sas( "../inputs/state_fips.sas7bdat"))  %>% 
  arrange(statecode, countycode) %>% 
  glimpse()

```

# import Census pop data

data: https://www2.census.gov/programs-surveys/popest/datasets/2020-2023/counties/asrh/cc-est2023-agesex-all.csv

```{r}
agesex <- read_csv("../raw_data/USCB/cc-est2023-agesex-all.zip") %>% 
  janitor::clean_names() %>% 
  glimpse()

# can also directly read from Census website
# agesex <- read_csv("https://www2.census.gov/programs-surveys/popest/datasets/2020-2023/counties/asrh/cc-est2023-agesex-all.csv") %>%
#   janitor::clean_names() %>% 
#   glimpse()
```

# helpers

Note: Some helper functions are used in multiple calculations. Those functions can be saved in one script and sourced in other scripts/RMD's. However, this RMD is intended to be standalone. 

## standardize fips

- This function standardizes the fips codes in the data frame to match the standard fips codes.
```{r}
standardize_fips <- function(df, df_fips){
  res <- fips %>% 
    select(statecode, countycode) %>% 
    left_join(df, by = c("statecode", "countycode"))
  
  return(res)
}
```


## add flag_CT

- This function adds a flag to the data frame for Connecticut counties.
- 'A' = data *available* for a CT county
- 'U' = data *unavailable* for a CT county

```{r}
add_flag_CT <- function(df, vnum, old="U", new = "A"){
  CT_old_lst <- c("001", "003", "005", "007", "009", "011", "013", "015")
  CT_new_lst <- c("110", "120", "130", "140", "150", "160", "170", "180", "190")

  res <- df %>% 
    mutate(flag_CT = case_when(
      statecode == "09" & countycode %in% CT_old_lst ~ old,
      statecode == "09" & countycode %in% CT_new_lst ~ new,
      TRUE ~ NA
    )) %>% 
    rename(!!(paste0(vnum, "_flag_CT")) := flag_CT)
  
  return(res)

}

```

# process data

POPESTIMATE: Total population
POPEST_FEM: Female population
AGE18PLUS_TOT: Total population age 18 years and over
AGE65PLUS_TOT: Total population age 65 years and over
```{r}
df1 <- agesex %>% 
  filter(year == 5) %>%  # YEAR: 5 = 7/1/2023 population estimate 
  select(statecode = state, countycode = county, 
         popestimate, popest_fem, age18plus_tot, age65plus_tot) %>% 
  glimpse()

```

## county level
v051, Population
v052, % Below 18 Years of Age
v053, % 65 and Older
v057, % Female
```{r}
df_cnt <- df1 %>%  
  mutate(v051_rawvalue = popestimate, # v051, Population
         v052_rawvalue = (popestimate - age18plus_tot)/popestimate, # v052, % Below 18 Years of Age
         v053_rawvalue = age65plus_tot/popestimate, # v053, % 65 and Older
         v057_rawvalue = popest_fem/popestimate, # v057, % Female
         v052_numerator = popestimate - age18plus_tot,
         v053_numerator = age65plus_tot,
         v057_numerator = popest_fem) %>% 
  select(-c(popestimate, popest_fem, age18plus_tot, age65plus_tot)) %>% 
  glimpse()
```

## state level

```{r}
df_st <- df1 %>% 
  mutate(countycode = "000") %>% 
  group_by(statecode, countycode) %>% 
  summarise(popestimate = sum(popestimate, na.rm = TRUE),
            popest_fem = sum(popest_fem, na.rm = TRUE), 
            age18plus_tot = sum(age18plus_tot, na.rm = TRUE), 
            age65plus_tot = sum(age65plus_tot, na.rm = TRUE),
            .groups = "drop") %>% 
  mutate(v051_rawvalue = popestimate,
         v052_rawvalue = (popestimate-age18plus_tot)/popestimate, 
         v053_rawvalue = age65plus_tot/popestimate,
         v057_rawvalue = popest_fem/popestimate,
         v052_numerator = popestimate-age18plus_tot,
         v053_numerator = age65plus_tot,
         v057_numerator = popest_fem) %>% 
  select(-c(popestimate, popest_fem, age18plus_tot, age65plus_tot))

df_st
```

## us

```{r}
df_us <- df1 %>% 
  summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE))) %>% 
  mutate(v051_rawvalue = popestimate,
         v052_rawvalue = (popestimate-age18plus_tot)/popestimate, 
         v053_rawvalue = age65plus_tot/popestimate,
         v057_rawvalue = popest_fem/popestimate,
         v052_numerator = popestimate-age18plus_tot,
         v053_numerator = age65plus_tot,
         v057_numerator = popest_fem) %>% 
  select(-c(popestimate, popest_fem, age18plus_tot, age65plus_tot)) %>% 
  mutate(statecode = "00", countycode = "000", .before = "v051_rawvalue")

df_us
```

## combine county, state, us

```{r}
df_all <- bind_rows(df_us, df_st, df_cnt) %>% 
  arrange(statecode, countycode)

df_all
```

# get individual measures

## v051

```{r}
v051 <- df_all %>% 
  select(statecode, countycode, v051_rawvalue) %>% 
  standardize_fips(fips) %>%
  add_flag_CT(vnum = "v051", old="U", new = "A")

v051
```

## v052

```{r}
v052 <- df_all %>% 
  select(statecode, countycode, v052_numerator,
         v052_denominator = v051_rawvalue, v052_rawvalue) %>% 
  standardize_fips(fips) %>%
  add_flag_CT(vnum = "v052", old="U", new = "A")

v052
```

## v053

```{r}
v053 <- df_all %>% 
  select(statecode, countycode, v053_numerator,
         v053_denominator = v051_rawvalue, v053_rawvalue) %>% 
  standardize_fips(fips) %>%
  add_flag_CT(vnum = "v053", old="U", new = "A")

v053
```


## v057

```{r}
v057 <- df_all %>% 
  select(statecode, countycode, v057_numerator,
         v057_denominator = v051_rawvalue, v057_rawvalue) %>% 
  standardize_fips(fips) %>%
  add_flag_CT(vnum = "v057", old="U", new = "A")

v057
```

# save data

```{r}
df_list <- list(v051, v052, v053, v057)
name_list <- list('v051', 'v052', 'v053', 'v057')

walk2(df_list, name_list, 
      ~ write_csv(x = .x, 
                  file = paste0("../measure_datasets/", .y, "_r2025",
                                ".csv") ))
```

