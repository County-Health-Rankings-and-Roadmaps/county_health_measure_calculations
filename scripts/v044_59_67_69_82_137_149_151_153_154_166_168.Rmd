---
title: "Measuers using ACS 5-year data - R2025"
author: "GL"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# About

**Note**: 

Instead of downloading the raw data for each measure from the Census website, we used a R Shiny app (https://uwmadison-glu.shinyapps.io/get-acs-data/) to extract all data needed for the measures in one csv file.

This app allows users to select all ACS variables needed for the measures and extract county, state and national data via Census API all at once.

However, the data access direction for each measure listed below remains valid.

Information on standard errors in the ACS can be found in this document:

https://www2.census.gov/programs-surveys/acs/tech_docs/statistical_testing/2023_Instructions_for_Stat_Testing_ACS.pdf

## v044	- Income inequality		

### Basic information

- Description
Ratio of household income at the 80th percentile to income at the 20th percentile.

- What is the numerator?
80th percentile of median household income

- What is the denominator?
20th percentile of median household income

### Raw data access

**Website to downloaded data**
https://data.census.gov/table?q=B19080&tid=ACSDT5Y2023.B19080

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table B19080 of the 2019-2023 ACS 5-year estimates.

rawvalue = 80th percentile median household income / 20th percentile median household income

rawvalue = upper limit 4th quintile / upper limit 1st quintile

## v059	- % not proficient in English	

### Basic information

- Description
Percentage of population aged 5 and over who reported speaking English less than well.

- What is the numerator?
Non-native English speakers who are not proficient in speaking English (speak less than "well")

- What is the denominator?
Total Population

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?q=B16005&tid=ACSDT5Y2023.B16005

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table B16005 of the 2019-2023 ACS 5-year estimates.

Total household population (n) = Total, as reported

People that are not proficient in English = Native and foreign born people that speak English "not well" or "not at all."

Percent of population not proficient in English = (People not proficient in English/Total population)*100

*numerator* = 
Estimate; Native: - Speak Spanish: - Speak English "not well" + 
Estimate; Native: - Speak Spanish: - Speak English "not at all" + 
Estimate; Native: - Speak other Indo-European languages: - Speak English "not well" + 
Estimate; Native: - Speak other Indo-European languages: - Speak English "not at all" + 
Estimate; Native: - Speak Asian and Pacific Island languages: - Speak English "not well" + 
Estimate; Native: - Speak Asian and Pacific Island languages: - Speak English "not at all" + 
Estimate; Native: - Speak other languages: - Speak English "not well" + 
Estimate; Native: - Speak other languages: - Speak English "not at all" +
Estimate; Foreign born: - Speak Spanish: - Speak English "not well" + 
Estimate; Foreign born: - Speak Spanish: - Speak English "not at all" + 
Estimate; Foreign born: - Speak other Indo-European languages: - Speak English "not well" + 
Estimate; Foreign born: - Speak other Indo-European languages: - Speak English "not at all" + 
Estimate; Foreign born: - Speak Asian and Pacific Island languages: - Speak English "not well" + 
Estimate; Foreign born: - Speak Asian and Pacific Island languages: - Speak English "not at all" + 
Estimate; Foreign born: - Speak other languages: - Speak English "not well" + 
Estimate; Foreign born: - Speak other languages: - Speak English "not at all"

*denominator* = 
Estimate; Total

## v067	- Driving alone to work		

### Basic information

- Description
Percentage of the workforce that drives alone to work.

- What is the numerator?
Workers that drove alone to work = Car, truck, or van: Drove alone, as reported

- What is the denominator?
Total labor force

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?q=B08301&tid=ACSDT5Y2023.B08301

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

Percent of labor force that drives alone to work

Data source(s): U.S. Census, American Community Survey, Table B08301 of the 2019-2023 ACS 5-year estimates.

Point estimate calculation:

1.  Total labor force (n) = Total, as reported
2.  Workers that drove alone to work = Car, truck, or van: Drove alone, as reported.
3.  Percent of workers that drove alone to work = (Workers that drove alone to work/Total labor force)*100

numerator = Estimate; Car, truck, or van: - Drove alone

denominator = Estimate; Total

95% Confidence Interval: see this document for formula: https://www2.census.gov/programs-surveys/acs/tech_docs/statistical_testing/2023_Instructions_for_Stat_Testing_ACS.pdf

## v067_other - Driving alone to work	(subgroups)

Notes for race-specific calculations:

- Values come from Table B08505B (black), B08505C (AI/AN), B08505D and B08505E (combine Asian other Pacific Islander into a single column), B08505I (hispanic), B08505H (white, non-Hispanic)
- If a subgroup rate is 0% or 100%, the rate and the CI is suppressed.
- If a county or state has fewer than 10 in the numerator, then ACS suppresses the value. Note that in 2022, some counties with fewer than 10 in the numerator were not suppressed by ACS so we used them to calculate a rawvalue 
- The national value is calculated by summing the state values 

## v069	- Some college			

### Basic information

- Description
Percentage of adults ages 25-44 with some post-secondary education.

- What is the numerator?
Total number of individuals ages 25-44 with at least some post secondary education

- What is the denominator?
Total number of individuals ages 25-44

### Raw data access

**Website to downloaded data**
https://data.census.gov/table?q=B15001&tid=ACSDT5Y2023.B15001

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table B15001 of the 2019-2023 ACS 5-year estimates.

Point Estimate:

1.  Population age 25-44 with some college education (n) = Sum of men age 25-34, men age 35-44, women age 25-34, women age 35-44 with some college (no degree), associate’s degree, bachelor’s degree, graduate or professional degree
1.  Total population age 25-44 = Sum of men age 25-34, men age 35-44, women age 25-34, women age 35-44.
1.  Percent of population age 25-44 with some college education = (Population age 25-44 with some college education/ Total population age 25-44)*100

*numerator* =
Estimate; Male: - 25 to 34 years: - Some college, no degree +
Estimate; Male: - 25 to 34 years: - Associate's degree +
Estimate; Male: - 25 to 34 years: - Bachelor's degree +
Estimate; Male: - 25 to 34 years: - Graduate or professional degree +
Estimate; Male: - 35 to 44 years: - Some college, no degree +
Estimate; Male: - 35 to 44 years: - Associate's degree +
Estimate; Male: - 35 to 44 years: - Bachelor's degree +
Estimate; Male: - 35 to 44 years: - Graduate or professional degree +
Estimate; Female: - 25 to 34 years: - Some college, no degree +
Estimate; Female: - 25 to 34 years: - Associate's degree +
Estimate; Female: - 25 to 34 years: - Bachelor's degree +
Estimate; Female: - 25 to 34 years: - Graduate or professional degree +
Estimate; Female: - 35 to 44 years: - Some college, no degree +
Estimate; Female: - 35 to 44 years: - Associate's degree +
Estimate; Female: - 35 to 44 years: - Bachelor's degree +
Estimate; Female: - 35 to 44 years: - Graduate or professional degree

*denominator* =
Estimate; Male: - 25 to 34 years +
Estimate; Male: - 35 to 44 years +
Estimate; Female: - 25 to 34 years +
Estimate; Female: - 35 to 44 years

## v082	- Children in single-parent households	

### Basic information

- Description
Percentage of children that live in a household headed by a single parent.

- What is the numerator?
The total number of children in a family household who live in a home with a single head of household

- What is the denominator?
The total number of children who live in family households

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?q=B09005&tid=ACSDT5Y2023.B09005

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table B09005 of the 2019-2023 ACS 5-year estimates.

Point Estimate:

1.  Total children in single-parent households (n) = Sum of children in single-headed households (male) and single-headed households (female)
2.  Total children in family households = As reported.
3.  Percent of children in single-parent households = (Total children in single-parent households/Total children in family households)*100

*numerator* =
[B09005_004E] Estimate; In family households: - In male householder, no spouse/partner present household +
[B09005_005E] Estimate; In family households: - In female householder, no spouse/partner present household

*denominator* =
[B09005_001E] Estimate; In family households

## v137	- Long commute - driving alone		

### Basic information

- Description
Among workers who commute in their car alone, the percentage that commute more than 30 minutes.

- What is the numerator?
The total number of workers who generally commute to work by driving alone who have a commute of longer than 30 minutes

- What is the denominator?
The total number of workers who generally commute to work by driving alone

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?q=S0802&tid=ACSDT5Y2023.S0802

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table S0802 of the 2019-2023 ACS 5-year estimates.

*Numerator* = (Car, truck, or van -- drove alone; Estimate; TRAVEL TIME TO WORK - 30 to 34 minutes) 

               + (Car, truck, or van -- drove alone; Estimate; TRAVEL TIME TO WORK - 35 to 44 minutes)

               + Car, truck, or van -- drove alone; Estimate; TRAVEL TIME TO WORK - 45 to 59 minutes)

               + (Car, truck, or van -- drove alone; Estimate; TRAVEL TIME TO WORK - 60 or more minutes)

*Denominator* = (Car, truck, or van -- drove alone; Estimate; Workers 16 years and over)

## v149	- Disconnected youth			

### Basic information

- Description
Percentage of teens and young adults ages 16-19 who are neither working nor in school.

- What is the numerator?
teens and young adults ages 16-19 who are neither working nor in school

- What is the denominator?
population ages 16-19

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?q=B14005&tid=ACSDT5Y2023.B14005

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table B14005 of the 2019-2023 ACS 5-year estimates.

*Numerator*: Follow the hierarchical structure in the ACS table as detailed below and the resulting 8 numbers are summed to generate the numerator.

Sum of:

[B14005_010]: Male --> Not Enrolled in School --> High school graduate --> Unemployed
[B14005_011]: Male --> Not enrolled in School --> High school graduate --> Not in labor force
[B14005_014]: Male --> Not enrolled in school --> Not high school graduate --> Unemployed
[B14005_015]: Male --> Not enrolled in school --> Not high school graduate --> Not in labor force
[B14005_024]: Female --> Not Enrolled in School --> High school graduate --> Unemployed
[B14005_025]: Female --> Not enrolled in School --> High school graduate --> Not in labor force
[B14005_028]: Female --> Not enrolled in school --> Not high school graduate --> Unemployed
[B14005_029]: Female --> Not enrolled in school --> Not high school graduate --> Not in labor force
 
*Denominator*: [B14005_001] Estimate, Total

## v151	- Gender pay gap	

### Basic information

- Description
Ratio of women's median earnings to men's median earnings for all full-time, year-round workers, presented as "cents on the dollar."

- What is the numerator?
Women's median earnings in the past 12 months (in 2022 inflation-adjusted dollars) for full-time, year-round workers ages 16 and older with earnings.

- What is the denominator?
Men's median earnings in the past 12 months (in 2022 inflation-adjusted dollars) for full-time, year-round workers ages 16 and older with earnings.

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?q=B09005&tid=ACSDT5Y2023.B09005

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select tables S2001 and S2002 of the 2019-2023 ACS 5-year estimates.

## v153	- Homeownership	

### Basic information

- Description
Percentage of owner-occupied housing units.

- What is the numerator?
Owner occupied housing units

- What is the denominator?
Occupied housing units

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?q=B25003&tid=ACSDT5Y2023.B25003

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table B25003 of the 2019-2023 ACS 5-year estimates.

*numerator* = B25003_002
Estimate; Total: - Owner occupied

*denominator* = B25003_001
Estimate; Total:

## v154	- Severe housing cost burden	

### Basic information

- Description
Percentage of households that spend 50% or more of their household income on housing.

- What is the numerator?
The number of households that spend 50.0 percent or more of their household income on housing

- What is the denominator?
otal occupied housing units for which housing cost burden is computed

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table B25074 and B25095 of the 2019-2023 ACS 5-year estimates.

*Numerator* =
{rent}
[B25074_009] Estimate; Less than $10,000: - 50.0 percent or more  +
[B25074_018] Estimate; \$10,000 to $19,999: - 50.0 percent or more +
[B25074_027] Estimate; \$20,000 to $34,999: - 50.0 percent or more +
[B25074_036] Estimate; \$35,000 to $49,999: - 50.0 percent or more +
[B25074_045] Estimate; \$50,000 to $74,999: - 50.0 percent or more +
[B25074_054] Estimate; \$75,000 to $99,999: - 50.0 percent or more +
[B25074_063] Estimate; $100,000 or more: - 50.0 percent or more +
{homeowner}
[B25095_009] Estimate; Less than $10,000: - 50.0 percent or more +
[B25095_018] Estimate; \$10,000 to $19,999: - 50.0 percent or more +
[B25095_027] Estimate; \$20,000 to $34,999: - 50.0 percent or more +
[B25095_036] Estimate; \$35,000 to $49,999: - 50.0 percent or more +
[B25095_045] Estimate; \$50,000 to $74,999: - 50.0 percent or more +
[B25095_054] Estimate; \$75,000 to $99,999: - 50.0 percent or more +
[B25095_063] Estimate; \$100,000 to $149,999: - 50.0 percent or more +
[B25095_072] Estimate; $150,000 or more: - 50.0 percent or more

*Denominator* =
[B25074_001] Estimate; Total: + 
[B25095_001] Estimate; Total: - 
[B25074_010] Estimate; Less than $10,000: - Not computed - 
[B25074_019] Estimate; \$10,000 to $19,999: - Not computed - 
[B25074_028] Estimate; \$20,000 to $34,999: - Not computed - 
[B25074_037] Estimate; \$35,000 to $49,999: - Not computed - 
[B25074_046] Estimate; \$50,000 to $74,999: - Not computed -
[B25074_055] Estimate; \$75,000 to $99,999: - Not computed -
[B25074_064] Estimate; $100,000 or more: - Not computed - 
[B25095_010] Estimate; Less than $10,000: - Not computed - 
[B25095_019] Estimate; \$10,000 to $19,999: - Not computed - 
[B25095_028] Estimate; \$20,000 to $34,999: - Not computed - 
[B25095_037] Estimate; \$35,000 to $49,999: - Not computed - 
[B25095_046] Estimate; \$50,000 to $74,999: - Not computed -
[B25095_055] Estimate; \$75,000 to $99,999: - Not computed -
[B25095_064] Estimate; \$100,000 to $149,999: - Not computed -
[B25095_073] Estimate; $150,000 or more: - Not computed

## v166	- Broadband access		

### Basic information

- Description
Percentage of households with broadband internet connection.

- What is the numerator?
The numerator is the number of households in a county with a broadband internet subscription such as cable, DSL, or fiber optic.

- What is the denominator?
Total households in county.

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?q=S2801&tid=ACSST5Y2023.S2801

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table S2801 of the 2019-2023 ACS 5-year estimates.

*denominator* = S2801_C01_001E

*numerator* = S2801_C01_014E

*rawvalue* = numerator/denominator

## v168	- High school completion

### Basic information

- Description
Percentage of adults ages 25 and over with a high school diploma or equivalent.

- What is the numerator?
Total number of individuals ages 25 and over with at least a high school diploma or equivalent in the county.

- What is the denominator?
Total number of individuals ages 25 and over in the county.

### Raw data access

**Website to downloaded data**
https://data.census.gov/cedsci/table?q=S1501&tid=ACSST5Y2023.S1501

**Online documentation** 
https://www.census.gov/programs-surveys/acs/technical-documentation.html

**Directions**

1.  Please refer to the page https://www.census.gov/programs-surveys/acs/data/data-tables.html or use any statistical package to retrieve table or data (http://www.census.gov/programs-surveys/acs/data/summary-file.html).
2.  Select table S1501 of the 2019-2023 ACS 5-year estimates.

*denominator* = S1501_C01_006E

*numerator* = S1501_C01_014E

Point Estimate:

1.  Population age 25 and over with high school diploma or higher (numerator)
2.  Total population 25 years and over (denominator)
3.  Percent of population 25 and over with high school diploma or higher = (Population age 25 and over with high school diploma or higher/ Total population 25 years and over)*100


# import packages

```{r}
library(tidyverse)
library(haven)

```

# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r }
fips <-  bind_rows(
  read_sas("../inputs/county_fips_with_ct_old.sas7bdat") ,
  read_sas( "../inputs/state_fips.sas7bdat"))  %>% 
  arrange(statecode, countycode) %>% 
  glimpse()

```

# helpers

## standardize column names

```{r}
standardize_col_names <- function(df, col_prefix){
  res <- df %>% 
    rename(
           !!(paste0(col_prefix, "_rawvalue")) := rawvalue, 
           !!(paste0(col_prefix, "_numerator")) := numerator,
           !!(paste0(col_prefix, "_denominator")) := denominator,
           !!(paste0(col_prefix, "_cilow")) := cilow,
           !!(paste0(col_prefix, "_cihigh")) := cihigh,
           !!(paste0(col_prefix, "_sourceflag")) := sourceflag
           )
  return(res)
}
```

## add flag_CT

- This function adds a flag to the data frame for Connecticut counties.
- 'A' = data *available* for a CT county
- 'U' = data *unavailable* for a CT county

```{r}
add_flag_CT <- function(df, vnum, old="U", new = "A"){
  CT_old_lst <- c("001", "003", "005", "007", "009", "011", "013", "015")
  CT_new_lst <- c("110", "120", "130", "140", "150", "160", "170", "180", "190")

  res <- df %>% 
    mutate(flag_CT = case_when(
      statecode == "09" & countycode %in% CT_old_lst ~ old,
      statecode == "09" & countycode %in% CT_new_lst ~ new,
      TRUE ~ NA
    )) %>% 
    rename(!!(paste0(vnum, "_flag_CT")) := flag_CT)
  
  return(res)

}

```

## standardize fips

```{r}
standardize_fips <- function(df){
  res <- fips %>% 
    select(statecode, countycode) %>% 
    left_join(df, by = c("statecode", "countycode"))
  
  return(res)
}

```

## Compute SE and CI for addable variables

```{r}
compute_se_ci <- function(df){
  df %>% 
    mutate(rawvalue = numerator/denominator,
       se_num = (sqrt(se_num_square))/1.645,
       se_denom = (sqrt(se_denom_square))/1.645) %>% 
  mutate(se_test = se_num^2 - (rawvalue^2 * se_denom^2)) %>% 
  mutate(se_pct = case_when(
    se_test>=0 ~ sqrt(se_num**2 - (rawvalue^2 * se_denom^2))/denominator,
    se_test< 0 ~ sqrt(se_num**2 + (rawvalue^2 * se_denom^2))/denominator
  )) %>% 
  mutate(cilow = rawvalue - se_pct*1.96, 
         cihigh = rawvalue + se_pct*1.96,
         sourceflag = NA_real_)
}
```

## Apply suppression and bounds

```{r}
apply_suppression <-  function(df){
  df %>% 
  mutate(
    cilow = case_when(cilow < 0 ~ 0,
                      is.na(cihigh) ~ NA_real_,
                      TRUE ~ cilow),
    cihigh = case_when(cihigh > 1 ~  1, 
                       is.na(cilow) ~ NA_real_,
                       TRUE ~ cihigh)
  )
}
```

## save data

```{r}
save_data <- function(df, vnum, output_dir = "../measure_datasets/") {
  df %>%
    write_csv(paste0(output_dir, vnum, "_r2025.csv"), na = "")
}
```


# raw data

**Note**: 
Instead of downloading the raw data for each measure from the Census website, we used a R Shiny app (https://uwmadison-glu.shinyapps.io/get-acs-data/) to extract all data needed for the measures in one csv file.

This app allows users to select all ACS variables needed for the measures and extract county, state and national data via Census API all at once.

## acs data: county, state, us
```{r}
acs5 <- read_csv("../raw_data/ACS/acs_data_2019-2023.zip")%>% 
  rename(fipscode = GEOID) %>% 
  glimpse()
```

# ------------------------

# Addable variables

# v059 % Not Proficient in English

numerator =	Non-native English speakers who are not proficient in speaking English (speak less than "well")
denominator	= Total Population
raw_value	= Percentage of non-native English speakers who are not proficient speaking English

## var list
```{r}
var_ls_059 <- c('B16005_007E', 'B16005_008E', 'B16005_012E', 'B16005_013E',
                'B16005_017E', 'B16005_018E', 'B16005_022E', 'B16005_023E', 
                'B16005_029E', 'B16005_030E', 'B16005_034E', 'B16005_035E',
                'B16005_039E', 'B16005_040E', 'B16005_044E', 'B16005_045E',
                'B16005_001E', 'B16005_007M', 'B16005_008M', 'B16005_012M',
                'B16005_013M', 'B16005_017M', 'B16005_018M', 'B16005_022M', 
                'B16005_023M', 'B16005_029M', 'B16005_030M', 'B16005_034M',
                'B16005_035M', 'B16005_039M', 'B16005_040M', 'B16005_044M', 
                'B16005_045M', 'B16005_001M')
```


## process data 

```{r}
notproficientinenglish <- acs5 %>% 
  select(2:3, all_of(var_ls_059)) %>% 
  arrange(statecode, countycode) %>% 
  mutate(numerator = B16005_007E + B16005_008E + B16005_012E + B16005_013E + 
           B16005_017E + B16005_018E + B16005_022E + B16005_023E + B16005_029E +
           B16005_030E + B16005_034E + B16005_035E + B16005_039E + B16005_040E +
           B16005_044E + B16005_045E, 
         denominator = B16005_001E,
         se_num_square = B16005_007M**2 + B16005_008M**2 + B16005_012M**2 +
           B16005_013M**2 + B16005_017M**2 + B16005_018M**2 + B16005_022M**2 + 
           B16005_023M**2 + B16005_029M**2 + B16005_030M**2 + B16005_034M**2 +
           B16005_035M**2 + B16005_039M**2 + B16005_040M**2 + B16005_044M**2 + 
           B16005_045M**2,
         se_denom_square = B16005_001M**2) %>% 
  select(-starts_with("B16005")) %>% 
  glimpse()

notproficientinenglish_2 <- notproficientinenglish %>% 
  compute_se_ci()

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

notproficientinenglish_3 <- notproficientinenglish_2 %>% 
  select(all_of(standard_cols))
```

## suppression + standardize column names

```{r}
notproficientinenglish_4 <- notproficientinenglish_3 %>%
  apply_suppression() %>% 
  ## standardize column names
  standardize_col_names("v059") %>% 
  glimpse()
```

## standardize fips and add flag_CT

```{r}
v059 <- notproficientinenglish_4 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v059", old="U", new = "A")

v059
```

## save 

```{r}
v059 %>% 
  save_data("v059")
```

#v067 - PERCENT OF LABOR FORCE THAT DRIVES ALONE TO WORK

numerator =	number of workers who commute alone to work via car, truck, or van.
denominator	= total workforce
raw_value	= Percentage of workers who drive alone to work

## var list
```{r}
var_ls_067 <- c('B08301_003E', 'B08301_001E', 'B08301_003M', 'B08301_001M')
```

## process data

```{r}
drivealone <- acs5 %>% 
  select(1:3, all_of(var_ls_067)) %>% 
  mutate(numerator = B08301_003E, 
         denominator = B08301_001E,
         se_num_square = B08301_003M**2,
         se_denom_square = B08301_001M**2) %>% 
  glimpse()

drivealone_2 <- drivealone %>% 
  compute_se_ci()

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

drivealone_3 <- drivealone_2 %>% 
  select(all_of(standard_cols))
```

## suppression+ standardize column names

```{r}
drivealone_4 <- drivealone_3 %>%
  apply_suppression() %>% 
  ## standardize column names
  standardize_col_names("v067")

```

## standardize fips and add flag_CT

```{r}
v067 <- drivealone_4 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v067", old="U", new = "A")

v067
```

## save 

```{r}
v067 %>% 
  save_data("v067")
```

# v067_other - Driving Alone to Work

`race_aian`	AIAN	Percentage of American Indian and Alaska Native workers who drive alone to work	
`race_asian`	Asian	Percentage of Asian/Pacific Islander workers who drive alone to work
`race_black`	Black	Percentage of Black workers who drive alone to work	Percentage
`race_hispanic`	Hispanic	Percentage of Hispanic workers who drive alone to work
`race_white`	white	Percentage of non-Hispanic white workers who drive alone to work

## var list
```{r}
var_ls_067_other <- c(
  'B08505B_002E', 'B08505H_002E', 'B08505I_002E', 'B08505D_002E', 'B08505E_002E',
  'B08505C_002E', 'B08505B_001E', 'B08505H_001E', 'B08505I_001E', 'B08505D_001E',
  'B08505E_001E', 'B08505C_001E', 'B08505B_002M', 'B08505H_002M', 'B08505I_002M',
  'B08505D_002M', 'B08505E_002M', 'B08505C_002M', 'B08505B_001M', 'B08505H_001M',
  'B08505I_001M', 'B08505D_001M', 'B08505E_001M', 'B08505C_001M'
)
```

## process data
```{r}
v067_other_1 <- acs5 %>% 
  select(1:3, all_of(var_ls_067_other)) %>% 
  # convert NA to 0, which is needed for adding two variables for Asian
  mutate(across(
    where(is.numeric), ~if_else(is.na(.x), 0, .x)
  )) %>% 
  mutate(
    v067_numerator_black = B08505B_002E,
    v067_numerator_white = B08505H_002E,
    v067_numerator_hispanic = B08505I_002E,
    v067_numerator_asian = B08505D_002E + B08505E_002E,
    v067_numerator_aian = B08505C_002E,
    v067_denominator_black = B08505B_001E,
    v067_denominator_white = B08505H_001E,
    v067_denominator_hispanic = B08505I_001E,
    v067_denominator_asian = B08505D_001E + B08505E_001E,
    v067_denominator_aian = B08505C_001E
  ) %>% 
  mutate(
    se_num_black_square = B08505B_002M**2,
    se_num_white_square = B08505H_002M**2,
    se_num_hispanic_square = B08505I_002M**2,
    se_num_asian_square = B08505D_002M**2+B08505E_002M**2,
    se_num_aian_square = B08505C_002M**2,
    se_denom_black_square = B08505B_001M**2,
    se_denom_white_square = B08505H_001M**2,
    se_denom_hispanic_square = B08505I_001M**2,
    se_denom_asian_square = B08505D_001M**2+B08505E_001M**2,
    se_denom_aian_square = B08505C_001M**2,
    se_num_black = (sqrt(se_num_black_square))/1.645,
    se_num_white = (sqrt(se_num_white_square))/1.645,
    se_num_hispanic = (sqrt(se_num_hispanic_square))/1.645,
    se_num_asian = (sqrt(se_num_asian_square))/1.645,
    se_num_aian = (sqrt(se_num_aian_square))/1.645,
    se_denom_black = (sqrt(se_denom_black_square))/1.645,
    se_denom_white = (sqrt(se_denom_white_square))/1.645,
    se_denom_hispanic = (sqrt(se_denom_hispanic_square))/1.645,
    se_denom_asian = (sqrt(se_denom_asian_square))/1.645,
    se_denom_aian = (sqrt(se_denom_aian_square))/1.645
         ) %>% 
  mutate(
    v067_race_black = v067_numerator_black/v067_denominator_black,
    v067_race_white = v067_numerator_white/v067_denominator_white,
    v067_race_hispanic = v067_numerator_hispanic/v067_denominator_hispanic,
    v067_race_asian = v067_numerator_asian/v067_denominator_asian,
    v067_race_aian = v067_numerator_aian/v067_denominator_aian
  ) %>% 
  select(-starts_with("B08505")) 

v067_other_1
```

```{r}
v067_other_2 <- v067_other_1 %>% 
  mutate(
    se_pct_black = sqrt(se_num_black**2 - (v067_race_black**2 * se_denom_black**2))/v067_denominator_black,
    se_pct_white = sqrt(se_num_white**2 - (v067_race_white**2 * se_denom_white**2))/v067_denominator_white,
    se_pct_hispanic = sqrt(se_num_hispanic**2 - (v067_race_hispanic**2 * se_denom_hispanic**2))/v067_denominator_hispanic,
    se_pct_asian = sqrt(se_num_asian**2 - (v067_race_asian**2 * se_denom_asian**2))/v067_denominator_asian,
    se_pct_aian = sqrt(se_num_aian**2 - (v067_race_aian**2 * se_denom_aian**2))/v067_denominator_aian
         ) %>% 
  mutate(
    se_pct_black = if_else(v067_race_black > 0 & is.nan(se_pct_black),
      sqrt(se_num_black**2 + (v067_race_black**2 * se_denom_black**2))/v067_denominator_black, 
      se_pct_black) ,
    se_pct_white = if_else(v067_race_white > 0 & is.nan(se_pct_white),
      sqrt(se_num_white**2 + (v067_race_white**2 * se_denom_white**2))/v067_denominator_white, 
      se_pct_white) ,
    se_pct_hispanic = if_else(v067_race_hispanic > 0 & is.nan(se_pct_hispanic),
      sqrt(se_num_hispanic**2 + (v067_race_hispanic**2 * se_denom_hispanic**2))/v067_denominator_hispanic, 
      se_pct_hispanic),
    se_pct_asian = if_else(v067_race_asian > 0 & is.nan(se_pct_asian),
      sqrt(se_num_asian**2 + (v067_race_asian**2 * se_denom_asian**2))/v067_denominator_asian, 
      se_pct_asian),
    se_pct_aian = if_else(v067_race_aian > 0 & is.nan(se_pct_aian),
      sqrt(se_num_aian**2 + (v067_race_aian**2 * se_denom_aian**2))/v067_denominator_aian, 
      se_pct_aian)
  ) %>% 
  mutate(v067_race_white_cilow = v067_race_white - (se_pct_white*1.96),
         v067_race_white_cihigh = v067_race_white + (se_pct_white*1.96),
         v067_race_black_cilow = v067_race_black - (se_pct_black*1.96),
         v067_race_black_cihigh = v067_race_black + (se_pct_black*1.96),
         v067_race_hispanic_cilow = v067_race_hispanic - (se_pct_hispanic*1.96),
         v067_race_hispanic_cihigh = v067_race_hispanic + (se_pct_hispanic*1.96),
         v067_race_asian_cilow = v067_race_asian - (se_pct_asian*1.96),
         v067_race_asian_cihigh = v067_race_asian + (se_pct_asian*1.96),
         v067_race_aian_cilow = v067_race_aian - (se_pct_aian*1.96),
         v067_race_aian_cihigh = v067_race_aian + (se_pct_aian*1.96))
```

```{r}
v067_other_3 <- v067_other_2 %>% 
  select(-starts_with(c("se", "fipscode"))) %>% 
  mutate(
    across(ends_with("_cilow"), ~if_else(.x <0, 0, .x)
           )
  ) %>% 
  mutate(
    across(ends_with("_cihigh"), ~if_else(.x >1, 1, .x)
           )
    ) %>% 
  glimpse()

```

## us data

```{r}
v067_other_us <- v067_other_3 %>% 
  filter(countycode == "000", statecode != "00") %>% 
  select(contains(c("numerator", "denominator"))) %>% 
  summarise(across(
    everything(), ~sum(.x, na.rm = TRUE)
  )) %>% 
  mutate(
    v067_race_black= v067_numerator_black/v067_denominator_black,
    v067_race_white= v067_numerator_white/v067_denominator_white,
    v067_race_hispanic= v067_numerator_hispanic/v067_denominator_hispanic,
    v067_race_asian= v067_numerator_asian/v067_denominator_asian,
    v067_race_aian= v067_numerator_aian/v067_denominator_aian
    ) %>% 
  select(-contains(c("numerator", "denominator"))) %>% 
  mutate(statecode = "00", countycode = "000", .before = 1)

v067_other_us 
  
```

## combine data

```{r}
v067_other_5 <- v067_other_3 %>% 
  filter(statecode!="00") %>% 
  bind_rows(v067_other_us) %>% 
  arrange(statecode, countycode) %>% 
  select(-contains("numerator"), -contains("denominator")) %>% 
  glimpse()
```

## standardize fips and add flag_CT

```{r}
v067_other_6 <- v067_other_5 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v067_race", old="U", new = "A")

v067_other_6
```

## save

```{r}
v067_other_6 %>% 
  save_data("v067_otherdata")
```

#v069 - SOME COLLEGE

numerator =	Total number of individuals ages 25-44 with at least some post-secondary education
denominator	= Total number of individuals ages 25-44.
raw_value	= Percentage of adults age 25-44 with some post-secondary education

## var list
```{r}
var_ls_069 <- c(
  'B15001_015E', 'B15001_016E', 'B15001_017E', 'B15001_018E', 'B15001_023E',
  'B15001_024E', 'B15001_025E', 'B15001_026E',
  'B15001_056E', 'B15001_057E', 'B15001_058E', 'B15001_059E', 'B15001_064E',
  'B15001_065E', 'B15001_066E', 'B15001_067E',
  'B15001_011E', 'B15001_019E', 'B15001_052E', 'B15001_060E',
  'B15001_015M', 'B15001_016M', 'B15001_017M', 'B15001_018M', 'B15001_023M',
  'B15001_024M', 'B15001_025M', 'B15001_026M',
  'B15001_056M', 'B15001_057M', 'B15001_058M', 'B15001_059M', 'B15001_064M',
  'B15001_065M', 'B15001_066M', 'B15001_067M',
  'B15001_011M', 'B15001_019M', 'B15001_052M', 'B15001_060M'
)
```


## process data
```{r}
somecollege <- acs5 %>% 
  select(1:3, all_of(var_ls_069)) %>% 
  mutate(numerator = B15001_015E+B15001_016E+B15001_017E+B15001_018E+B15001_023E+
           B15001_024E+B15001_025E+B15001_026E+ B15001_056E +B15001_057E+ B15001_058E+ 
           B15001_059E+B15001_064E+B15001_065E+B15001_066E+B15001_067E, 
         denominator = B15001_011E+B15001_019E+B15001_052E+B15001_060E,
         se_num_square = B15001_015M**2+B15001_016M**2+B15001_017M**2+B15001_018M**2+ 
           B15001_023M**2+B15001_024M**2+B15001_025M**2+B15001_026M**2+B15001_056M**2+
           B15001_057M**2+B15001_058M**2+B15001_059M**2+B15001_064M**2+
           B15001_065M**2+B15001_066M**2+B15001_067M**2,
         se_denom_square = B15001_011M**2+B15001_019M**2+B15001_052M**2+
           B15001_060M**2) %>% 
  glimpse()

somecollege_2 <- somecollege %>% 
  compute_se_ci()

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

somecollege_3 <- somecollege_2 %>% 
  select(all_of(standard_cols))
```

## suppression + standardize column names

```{r}
somecollege_4 <- somecollege_3 %>%
  apply_suppression() %>%  
  ## standardize column names
  standardize_col_names("v069")
```

## standardize fips and add flag_CT

```{r}
v069 <- somecollege_4 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v069", old="U", new = "A")

v069
```

## save 

```{r}
v069 %>% 
  save_data("v069")
```

#v082 - SINGLE-PARENT HOUSEHOLDS

numerator =	Number of children that live in single-parent households
denominator	= Number of children in households
raw_value	= Percentage of children that live in single-parent households

## var list
```{r}
var_ls_082 <- c('B09005_001E', 'B09005_004E', 'B09005_005E', 
                'B09005_001M', 'B09005_004M', 'B09005_005M')
```

## process data
```{r}
singleparenthh <- acs5 %>% 
  select(1:3, all_of(var_ls_082)) %>% 
  mutate(numerator = B09005_004E + B09005_005E, 
         denominator = B09005_001E,
         se_num_square = B09005_004M**2 + B09005_005M**2,
         se_denom_square = B09005_001M**2) %>% 
  glimpse()

singleparenthh_2 <- singleparenthh %>% 
  compute_se_ci()

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

singleparenthh_3 <- singleparenthh_2 %>% 
  select(all_of(standard_cols))
```

## suppression + standardize column names

```{r}
singleparenthh_4 <- singleparenthh_3 %>%
  apply_suppression() %>% 
  mutate(across(c(cilow, cihigh), ~if_else(is.nan(rawvalue), NA, .))) %>% 
  # setting '15005' to missing because numerator and denominator are 0 which isn't helpful
  mutate(numerator = if_else((statecode=="15" & countycode=="005"), NA, numerator),
         denominator = if_else((statecode=="15" & countycode=="005"), NA, denominator),
         cilow = if_else((statecode=="15" & countycode=="005"), NA, cilow),
         cihigh = if_else((statecode=="15" & countycode=="005"), NA, cihigh)) %>% 
  ## standardize column names
  standardize_col_names("v082")
```

## standardize fips and add flag_CT

```{r}
v082 <- singleparenthh_4 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v082", old="U", new = "A")

v082
```

## save 

```{r}
v082 %>% 
  save_data("v082")
```

# v149 - DISCONNECTED YOUTH

numerator =	number of people, ages 16-19, who are neither working nor in school
denominator	= total county population, ages 16-19
raw_value	= Percentage of teens and young adults ages 16-19 who are neither working nor in school

## var list
```{r}
var_ls_149 <- c(
  'B14005_010E', 'B14005_011E', 'B14005_014E', 'B14005_015E', 'B14005_024E',
  'B14005_025E', 'B14005_028E', 'B14005_029E', 'B14005_001E', 
  'B14005_010M', 'B14005_011M', 'B14005_014M', 'B14005_015M', 'B14005_024M',
  'B14005_025M', 'B14005_028M', 'B14005_029M', 'B14005_001M'
)
```

## process data

```{r}
disconnectedyouth <- acs5 %>% 
  select(1:3, all_of(var_ls_149)) %>% 
  mutate(numerator = B14005_010E + B14005_011E + B14005_014E + B14005_015E +
           B14005_024E + B14005_025E + B14005_028E + B14005_029E, 
         denominator = B14005_001E,
         se_num_square = B14005_010M**2 + B14005_011M**2 + B14005_014M**2 +
           B14005_015M**2 + B14005_024M**2 + B14005_025M**2 +
           B14005_028M**2 + B14005_029M**2,
         se_denom_square = B14005_001M**2) %>% 
  glimpse()

disconnectedyouth_2 <- disconnectedyouth %>% 
  mutate(
    rawvalue = numerator/denominator,
    se_num = (sqrt(se_num_square))/1.645,
    se_denom = (sqrt(se_denom_square))/1.645
    ) %>% 
  mutate(se_test = se_num^2 - (rawvalue^2 * se_denom^2)) %>% 
  mutate(se_pct = case_when(
    se_test>=0 ~ sqrt(se_num**2 - (rawvalue^2 * se_denom^2))/denominator,
    se_test< 0 ~ sqrt(se_num**2 + (rawvalue^2 * se_denom^2))/denominator
  )) %>% 
  mutate(cilow = rawvalue - se_pct*1.96, 
         cihigh = rawvalue + se_pct*1.96,
         relative_standard_error = se_pct/rawvalue,
         sourceflag = NA_real_)

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 
                   'relative_standard_error',
                   'sourceflag'
                   )

disconnectedyouth_3 <- disconnectedyouth_2 %>% 
  select(all_of(standard_cols))
```

## suppression + standardize column names

```{r}
disconnectedyouth_4 <- disconnectedyouth_3 %>%
  mutate(
    cilow = if_else(cilow < 0,  0, cilow),
    cihigh = if_else(cihigh > 1,  1, cihigh)
  ) %>% 
  mutate(
    rawvalue = case_when(
      rawvalue == 0 ~ NA_real_,
      rawvalue == 1 ~ NA_real_,
      TRUE ~ rawvalue
    )
  ) %>% 
  mutate(rawvalue = if_else(relative_standard_error > 0.35,
                            NA_real_, rawvalue)) %>% 
  mutate(across(c(numerator, denominator, cilow, cihigh), 
                ~if_else(is.na(rawvalue), NA_real_, .x))) %>% 
  # standard column names
  standardize_col_names("v149")
```

## standardize fips and add flag_CT

```{r}
v149 <- disconnectedyouth_4 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v149", old="U", new = "A")

v149
```

## save 

```{r}
v149 %>% 
  save_data("v149")
```


# v153 - Homeownership

numerator	= # Homeowners
denominator = total tenure (B25003_001E) (Occupied Housing Units)
raw_value = 	% Homeowners

## var list
```{r}
var_ls_153 <- c('B25003_001E', 'B25003_001M',
                'B25003_002E', 'B25003_002M')
```

## process data

```{r}
homeownership <- acs5 %>% 
  select(1:3, all_of(var_ls_153)) %>% 
  rename(numerator = B25003_002E, 
         denominator = B25003_001E) %>% 
  mutate(rawvalue = numerator/denominator,
         se_num_square = B25003_002M**2,
         se_denom_square = B25003_001M**2) %>% 
  glimpse()

homeownership_2 <- homeownership %>% 
  compute_se_ci()

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

homeownership_3 <- homeownership_2 %>% 
  select(all_of(standard_cols))
```

## suppression + standardize column names

```{r}
homeownership_5 <- homeownership_3 %>%
  apply_suppression() %>% 
  # standard column names
  standardize_col_names("v153")
```

## standardize fips and add flag_CT

```{r}
v153 <- homeownership_5 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v153", old="U", new = "A")

v153
```

## save 

```{r}
v153 %>% 
  save_data("v153")
```


# v154 - SEVERE HOUSING COST BURDEN

numerator	= total number of households in a county that spend 50% or more of their household income on housing
denominator = total occupied housing units for which housing cost burden is computed in a county
raw_value = Percentage of households that spend 50% or more of their household income on housing	

## note: 
we can use `B25074_001E` to replace:
$$
\text {B25074_001E = B25074_002E + B25074_011E + B25074_020E + B25074_029E + B25074_038E + B25074_047E + B25074_056E}
$$
           
we can use `B25095_001E` to replace:
$$
\text
{B25095_001E = B25095_002E + B25095_011E + B25095_020E + B25095_029E + B25095_038E + B25095_047E + B25095_056E + B25095_065E}
$$

The replacements lead to the same results and will make the logic and calculations more consistent. 

## var list
```{r}
var_ls_154_rent <- c(
  'B25074_009E', 'B25074_018E', 'B25074_027E', 'B25074_036E', 'B25074_045E',
  'B25074_054E', 'B25074_063E', 'B25074_002E', 'B25074_011E', 'B25074_020E',
  'B25074_029E', 'B25074_038E', 'B25074_047E', 'B25074_056E', 'B25074_010E',
  'B25074_019E', 'B25074_028E', 'B25074_037E', 'B25074_046E', 'B25074_055E',
  'B25074_064E', 
  'B25074_009M', 'B25074_018M', 'B25074_027M', 'B25074_036M', 'B25074_045M',
  'B25074_054M', 'B25074_063M', 'B25074_001M', 'B25074_010M', 'B25074_019M',
  'B25074_028M', 'B25074_037M', 'B25074_046M', 'B25074_055M', 'B25074_064M'
)

var_ls_154_homeowner <- c(
  'B25095_009E', 'B25095_018E', 'B25095_027E', 'B25095_036E', 'B25095_045E',
  'B25095_054E', 'B25095_063E', 'B25095_072E', 'B25095_002E', 'B25095_011E',
  'B25095_020E', 'B25095_029E', 'B25095_038E', 'B25095_047E', 'B25095_056E',
  'B25095_065E', 'B25095_010E', 'B25095_019E', 'B25095_028E', 'B25095_037E',
  'B25095_046E', 'B25095_055E', 'B25095_064E', 'B25095_073E',
  'B25095_009M', 'B25095_018M', 'B25095_027M', 'B25095_036M', 'B25095_045M',
  'B25095_054M', 'B25095_063M', 'B25095_072M', 'B25095_001M', 'B25095_010M',
  'B25095_019M', 'B25095_028M', 'B25095_037M', 'B25095_046M', 'B25095_055M',
  'B25095_064M','B25095_073M'
)
```


## process data

-   note: 
in general, 
B25074_002E + B25074_011E + B25074_020E + B25074_029E + B25074_038E + B25074_047E + B25074_056E = `B25074_001E`

this is why `B25074_001M` is used (instead of B25074_002E, ..., B25074_056E) when calculating `se_denom_square` for 'rent'

similar situation for `se_denom_square` for 'homeowner'

```{r}
SHCB_rent <- acs5 %>% 
  select(1:3, all_of(var_ls_154_rent)) %>% 
  mutate(numerator = B25074_009E + B25074_018E + B25074_027E + B25074_036E +
           B25074_045E + B25074_054E + B25074_063E, 
         denominator = B25074_002E + B25074_011E + B25074_020E + B25074_029E +
           B25074_038E + B25074_047E + B25074_056E - B25074_010E - B25074_019E -
           B25074_028E - B25074_037E - B25074_046E - B25074_055E - B25074_064E) %>% 
  mutate(
    # rawvalue = numerator/denominator,
         se_num_square = B25074_009M**2 + B25074_018M**2 + B25074_027M**2 +
           B25074_036M**2 + B25074_045M**2 + B25074_054M**2 + B25074_063M**2,
         se_denom_square = B25074_001M**2 + B25074_010M**2 + B25074_019M**2 +
           B25074_028M**2 + B25074_037M**2 + B25074_046M**2 + B25074_055M**2 +
           B25074_064M**2) %>% 
  glimpse()

SHCB_homeowner <- acs5 %>% 
  select(1:3, all_of(var_ls_154_homeowner)) %>% 
  mutate(numerator = B25095_009E + B25095_018E + B25095_027E + B25095_036E +
           B25095_045E + B25095_054E + B25095_063E + B25095_072E, 
         denominator = B25095_002E + B25095_011E + B25095_020E + B25095_029E +
           B25095_038E + B25095_047E + B25095_056E + B25095_065E - B25095_010E -
           B25095_019E - B25095_028E - B25095_037E - B25095_046E - B25095_055E -
           B25095_064E - B25095_073E) %>% 
  mutate(
    # rawvalue = numerator/denominator,
         se_num_square = B25095_009M**2 + B25095_018M**2 + B25095_027M**2 +
           B25095_036M**2 + B25095_045M**2 + B25095_054M**2 + B25095_063M**2 +
           B25095_072M**2,
         se_denom_square = B25095_001M**2 + B25095_010M**2 + B25095_019M**2 +
           B25095_028M**2 + B25095_037M**2 + B25095_046M**2 + B25095_055M**2 +
           B25095_064M**2 + B25095_073M**2) %>% 
  glimpse()

SHCB <- bind_rows(SHCB_rent %>% 
            select(-starts_with("B")), 
          SHCB_homeowner %>% 
            select(-starts_with("B"))) %>% 
  arrange(fipscode) %>% 
  group_by(fipscode, statecode, countycode) %>% 
  summarise(across(where(is.numeric), ~ sum(.x, na.rm = TRUE)), .groups = "drop") 
```

```{r}
SHCB_2 <- SHCB %>% 
  compute_se_ci()

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

SHCB_3 <- SHCB_2 %>% 
  select(all_of(standard_cols))
```

## suppression + standardize column names

```{r}
SHCB_5 <- SHCB_3 %>%
  apply_suppression() %>% 
  mutate(across(
    where(is.numeric), ~if_else(rawvalue==0, NA_real_, .x)
  )) %>% 
  # standard column names
  standardize_col_names("v154") %>% 
  arrange(statecode, countycode)
```

## standardize fips and add flag_CT

```{r}
v154 <- SHCB_5 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v154", old="U", new = "A")

v154
```

## save 

```{r}
v154 %>% 
  save_data("v154")
```


# v166 - BROADBAND

denominator = S2801_C01_001E
numerator = S2801_C01_014E
rawvalue = numerator/denominator

raw_value =	% of households with broadband internet connection

## var list
```{r}
var_ls_166 <- c('S2801_C01_014E', 'S2801_C01_014M',
                'S2801_C01_001E', 'S2801_C01_001M')
```

## process data
```{r}
broadband <- acs5 %>% 
  select(1:3, all_of(var_ls_166)) %>% 
  rename(numerator = S2801_C01_014E, 
         denominator = S2801_C01_001E) %>% 
  mutate(se_num_square = S2801_C01_014M**2,
         se_denom_square = S2801_C01_001M**2) %>% 
  glimpse()

broadband_2 <- broadband %>% 
  compute_se_ci()

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

broadband_3 <- broadband_2 %>% 
  select(all_of(standard_cols))

```

## suppression + standardize column names

```{r}
broadband_5 <- broadband_3 %>%
  apply_suppression() %>%  
  # standard column names
  standardize_col_names("v166")
```

## standardize fips and add flag_CT

```{r}
v166 <- broadband_5 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v166", old="U", new = "A")

v166
```

## save 

```{r}
v166 %>% 
  save_data("v166")
```


#v168 - HIGH SCHOOL COMPLETION

numerator =	# Completed High School (Adults age 25 and over with a high school diploma or equivalent)
denominator =	Population	(Adults age 25 and over)
raw_value	= % Completed High School

## var list
```{r}
var_ls_168 <- c('S1501_C01_014E', 'S1501_C01_014M',
                'S1501_C01_006E', 'S1501_C01_006M')
```

## process data
```{r}
hs_completion <- acs5 %>% 
  select(1:3, all_of(var_ls_168)) %>% 
  rename(numerator = S1501_C01_014E, 
         denominator = S1501_C01_006E) %>% 
  mutate(se_num_square = S1501_C01_014M**2,
         se_denom_square = S1501_C01_006M**2) %>% 
  glimpse()

hs_completion_2 <- hs_completion %>% 
  compute_se_ci()

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

hs_completion_3 <- hs_completion_2 %>% 
  select(all_of(standard_cols))
```

## suppression + standardize column names

```{r}
hs_completion_5 <- hs_completion_3 %>%
  apply_suppression() %>% 
  # standard column names
  standardize_col_names("v168")
```

## standardize fips and add flag_CT

```{r}
v168 <- hs_completion_5 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v168", old="U", new = "A")

v168
```

## save 

```{r}
v168 %>% 
  save_data("v168")
```


# ---------------
# Non-addable variables

# v044 - INCOME INEQUALITY

numerator =	80th Percentile Income
denominator	= 20th Percentile Income
raw_value	= Income Ratio

## var list
```{r}
var_ls_044 <- c('B19080_001E', 'B19080_004E', 'B19080_001M', 'B19080_004M')
```

## process data
```{r}
incomeinequality <- acs5 %>% 
  select(1:3, all_of(var_ls_044)) %>% 
  rename(numerator = B19080_004E, 
         denominator = B19080_001E) %>% 
  glimpse()

incomeinequality_2 <- incomeinequality %>% 
  # filter(is.na(B19080_004M) | is.na(B19080_001M)) %>% 
  mutate(denominator = if_else(is.na(B19080_004M) | is.na(B19080_001M),
                               NA_real_, denominator)) %>%
  mutate(rawvalue = numerator/denominator,
       se_pre_num = (B19080_004M/1.645)*1.96, 
       se_pre_den = (B19080_001M/1.645)*1.96) %>% 
  mutate(se_ratio_pre = 
           ((se_pre_num**2)+((numerator/denominator)**2)*(se_pre_den**2))**.5,
         se_ratio = 1/denominator * se_ratio_pre) %>% 
  mutate(cilow = rawvalue - se_ratio, 
         cihigh = rawvalue + se_ratio,
         sourceflag = NA_real_)

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

incomeinequality_3 <- incomeinequality_2 %>% 
  select(all_of(standard_cols)) %>% 
  glimpse()
```

## standardize column names

```{r}
incomeinequality_4 <- standardize_col_names(incomeinequality_3, "v044") %>% 
  glimpse()
```

## suppression

```{r}
incomeinequality_5 <- incomeinequality_4 %>% 
  mutate(v044_numerator = if_else(is.na(v044_rawvalue),
                                  NA_real_, v044_numerator),
         v044_cilow = if_else(v044_cilow <0 & v044_cilow>-50, 
                              0, v044_cilow)
         )
```

## standardize fips and add flag_CT

```{r}
v044 <- incomeinequality_5 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v044", old="U", new = "A")

v044
```


## save 

```{r}
v044 %>% 
  save_data("v044")
```

# v151 - Gender Pay Gap

numerator	= Women's Median Earnings
denominator	= Men's Median Earnings
raw_value	= Gender Pay Gap, Ratio of women’s median earnings to men’s median earnings

## var list
```{r}
var_ls_151 <- c('S2001_C05_013E', 'S2001_C05_013M', 
                'S2001_C03_013E', 'S2001_C03_013M')
```

## process data
```{r}
genderpaygap <- acs5 %>% 
  select(1:3, all_of(var_ls_151)) %>% 
  rename(numerator = S2001_C05_013E, 
         denominator = S2001_C03_013E) %>% 
  mutate(rawvalue = numerator/denominator,
         se_pre_num = (S2001_C05_013M/1.645)*1.96, 
         se_pre_den = (S2001_C03_013M/1.645)*1.96) %>% 
  glimpse()

genderpaygap_2 <- genderpaygap %>% 
  mutate(se_ratio_pre = 
           ((se_pre_num**2)+((numerator/denominator)**2)*(se_pre_den**2))**.5,
         se_ratio = 1/denominator * se_ratio_pre) %>% 
  mutate(cilow = rawvalue - se_ratio, 
         cihigh = rawvalue + se_ratio,
         sourceflag = NA_real_)

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

genderpaygap_3 <- genderpaygap_2 %>% 
  select(all_of(standard_cols))
```

## suppression + standardize column names

```{r}
genderpaygap_5 <- genderpaygap_3 %>% 
  mutate(numerator = if_else(is.na(denominator),
                                  NA_real_, numerator),
         denominator = if_else(is.na(numerator), 
                              NA_real_, denominator)
         ) %>% 
  mutate(
    cilow = if_else(!(is.na(cilow)) & cilow < 0,  0, cilow)
  ) %>% 
  # standard column names
  standardize_col_names("v151") %>% 
  glimpse()
```

## standardize fips and add flag_CT

```{r}
v151 <- genderpaygap_5 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v151", old="U", new = "A")

v151
```

## save 

```{r}
v151 %>% 
  save_data("v151")
```


# v137 - LONG COMMUTE - DRIVING ALONE 

numerator =	number of workers who drive alone (via car, truck, or van) for more than 30 minutes during their commute
denominator	= number of workers who drive alone (via car, truck, or van) during their commute
raw_value	= Among workers who commute in their car alone, the percentage that commute more than 30 minutes

## var list
```{r}
var_ls_137 <- c(
  'S0802_C01_001E', 'S0802_C01_001M', 'S0802_C02_086E', 'S0802_C02_086M',
  'S0802_C02_087E', 'S0802_C02_087M', 'S0802_C02_088E', 'S0802_C02_088M',
  'S0802_C02_089E', 'S0802_C02_089M')
```

## process data
```{r}
longcommute <- acs5 %>% 
  select(1:3, all_of(var_ls_137)) %>% 
  rename(denominator = S0802_C01_001E) %>% 
  glimpse()

longcommute_2 <- longcommute %>% 
  mutate(
    numerator = NA_real_,
    rawvalue = S0802_C02_086E + S0802_C02_087E + S0802_C02_088E + 
           S0802_C02_089E,
    se = (sqrt(S0802_C02_086M**2 + S0802_C02_087M**2 + S0802_C02_088M**2 +
                    S0802_C02_089M**2))*1.96/1.645
       ) %>% 
  mutate(cilow = rawvalue - se, 
         cihigh = rawvalue + se,
         sourceflag = NA_real_)

standard_cols <- c('statecode', 'countycode', 'numerator', 'denominator',
                   'rawvalue', 'cilow', 'cihigh', 'sourceflag')

longcommute_3 <- longcommute_2 %>% 
  select(all_of(standard_cols)) %>% 
  mutate(across(c(rawvalue, cilow, cihigh), ~ .x/100) ) %>% 
  glimpse()
```

## suppression + standardize column names

```{r}
longcommute_4 <- longcommute_3 %>%
  apply_suppression() %>% 
  # standard column names
  standardize_col_names("v137") %>% 
  glimpse()
```

## standardize fips and add flag_CT

```{r}
v137 <- longcommute_4 %>% 
  standardize_fips() %>% 
  add_flag_CT(vnum = "v137", old="U", new = "A")

v137
```

## save 

```{r}
v137 %>% 
  save_data("v137")
```

