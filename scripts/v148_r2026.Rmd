---
title: "v148 Firearm Fatalities - R2026"
author: "GL (modified for 2026 by how)"
output: html_document"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# about

## Basic information

- Description
Number of deaths due to firearms per 100,000 population.

- What is the numerator?
The numerator is the number of deaths in a county over the 5-year period due to firearms as defined by ICD-10 codes W32-W34, X72-X74, X93-X95, Y22-Y24, and Y350.

- What is the denominator?
The denominator is the aggregate annual population over the five-year period.

## Raw data access

- NCHS mortality and natality data 2019-2023: the data is requested

# import packages

```{r}
library(tidyverse)
library(haven)
```

# set up directory

```{r}
# set up directory that holds data needed for calculations
# NCHS mortality data, not allowed to share in GitHub
nchs_mort_dir <- "D:/CHRR/mortality raw"

# NCHS natality data, not allowed to share in GitHub
nchs_nata_dir <- "D:/CHRR/natality raw"

# Census county population estimates data
census_pop_dir <- "D:/CHRR/pop raw"
```


# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r }
fips <-  bind_rows(
  read_sas("../inputs/county_fips_with_ct_old.sas7bdat"),
  read_sas( "../inputs/state_fips.sas7bdat")) %>% 
  arrange(statecode, countycode) %>% 
  glimpse()

```

# helpers

## functions used commonly by NCHS measures

- some commonly used functions are in a separate file, `nchs_measure_helpers.R`. 
```{r}
source("../scripts/nchs_measure_helpers.R")
```

## function to process pop data for v148

```{r}
process_pop <- function(year){
  
  pop <- read_census_pop(file_name = get_census_csv_file_info(year)$file_name ) %>% 
    get_census_tot_pop(year_num = get_census_csv_file_info(year)$year_num, by_race = FALSE)
  
  return(pop)
}
```

## function to process mortality data for v148

```{r}
process_mort <- function(year, icd){
  
  print(get_mort_file_name(year))
  
  mort <- read_mort_data(
    file_path = file.path(nchs_mort_dir, get_mort_file_name(year) ), 
    header = mort_header,
    n_max = Inf) %>% 
    glimpse() %>% 
    get_mort_filtered_by_icd(df_fips=fips, icd, by_race = FALSE)
  
  return(mort)
}
```

# pop 2019-2023

```{r}
pop_all <- bind_rows(
  process_pop(2019),
  process_pop(2020),
  process_pop(2021),
  process_pop(2022) %>% fix_CT_pop(process_pop(2021)),
  process_pop(2023) %>% fix_CT_pop(process_pop(2021))) %>% 
  group_by(statecode, countycode) %>% 
  summarise(pop = sum(pop), .groups = "drop") %>% 
  filter(!(statecode == "02" & countycode == "261") ) %>% # remove 02261
  glimpse()
```


# NCHS mort data 

## header

```{r}
mort_header <- tribble(
  ~fld_name, ~start,  ~end,
  "state_of_residence", 29,  30,
  "county_of_residence", 35,  37,
  "icd_code", 146, 149
)
```

## icd codes for v148

```{r}
icd_code_lst <- c('W32','W33','W34','X72','X73','X74','X93','X94','X95','Y22','Y23','Y24',
				'Y350')

```

## mort 5 years
```{r}
mort_all <- bind_rows(
  c(2019:2023) %>% 
    map(~process_mort(year = ., icd_code_lst))
  ) %>% 
  group_by(statecode, countycode) %>% 
  summarise(deaths = sum(deaths), .groups = "drop")

```


# mortality calculation

## merge mort and pop data

```{r}
merged <- pop_all %>% 
  left_join(mort_all, 
            by = c("statecode", "countycode"))
  
```

## confidence Intervals

```{r}
v148 <- merged %>%
  rename(numerator = deaths, denominator = pop) %>%
  mutate(
    rawvalue = numerator / denominator *100000,
    rse = 100 * sqrt(1/numerator),
  ) %>%
  mutate(
    std = rawvalue * rse / 100,
    cilow = rawvalue - 1.96 * std,
    cihigh = rawvalue + 1.96 * std
  ) %>%
  select(-c(rse, std))

```

## calculate CI L and U for n < 100

```{r}
suppress_limit <- 10

v148_2 <- v148 %>% 
  left_join(get_pois_CI(), by = c("numerator" = "n")) %>% 
  mutate(cilow = if_else(numerator>= suppress_limit & numerator <=99,
                         rawvalue * L, cilow),
         cihigh = if_else(numerator>=suppress_limit & numerator <=99,
                         rawvalue * U, cihigh)) %>% 
  select(-c(L, U)) %>% 
  mutate(across(where(is.numeric), ~ if_else(numerator < suppress_limit, 
                                            NA_real_, .x))) %>% 
  mutate(sourceflag  = NA_real_) %>% 
  rename_with(.fn = ~paste0("v148_", .x), .cols = c("denominator", "numerator","rawvalue", "cilow" , "cihigh" ,"sourceflag"))

```

# standardize FIPS add flag_CT

```{r}
v148_3 <- fips %>%
  select(statecode, countycode) %>%
  left_join(v148_2, by = c("statecode", "countycode")) %>%
  add_flag_CT(vnum="v148", old = "U", new = "A")

```


# compare initial and duplicated calculations

```{r}
compare("v148", v148_3, 2026)
```


# save data
```{r}
save_data(v148_3, "v148")
```
