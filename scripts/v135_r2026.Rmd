---
title: "v135 Injury deaths - Ranking 2026"
author: "GL - updated by HOW for 2026"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# about

## Basic information

- Description
Number of deaths due to injury per 100,000 population.

- What is the numerator?
The numerator is the number of deaths with an underlying cause of injury (ICD-10 codes *U01-*U03, V01-Y36, Y85-Y87, Y89) during the five-year period.

- What is the denominator?
The denominator is the aggregate annual population for the five-year period.

## Raw data access

- NCHS mortality and natality data 2019-2023: the data is requested

- Connecticut mortality data: data is requested; for new CT counties (i.e., planning regions)

- Census population estimates 2019-2023 from: https://www2.census.gov/programs-surveys/popest/datasets

# import packages

```{r}
library(tidyverse)
library(haven)
```

# set up directory

```{r}
# set up directory that holds data needed for calculations
# NCHS mortality data, not allowed to share in GitHub
nchs_mort_dir <- "D:/CHRR/mortality raw"

# NCHS natality data, not allowed to share in GitHub
nchs_nata_dir <- "D:/CHRR/natality raw"

# Census county population estimates data
census_pop_dir <- "D:/CHRR/pop raw"

# Connecticut mortality data, not allowed to share in GitHub
# these data are in my mortality folder 
CT_mort_dir <- "D:/CHRR/mortality raw"
```

# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r }
fips <-  bind_rows(
  read_sas("../inputs/county_fips_with_ct_old.sas7bdat"),
  read_sas( "../inputs/state_fips.sas7bdat")) %>% 
  arrange(statecode, countycode) %>% 
  glimpse()

```

# helpers

## functions used commonly by NCHS measures

- some commonly used functions are in a separate file, `nchs_measure_helpers.R`. 
```{r}
source("../scripts/nchs_measure_helpers.R")
```

## function to process pop data for v148

```{r}
process_pop <- function(year){
  
  pop <- read_census_pop(file_name = get_census_csv_file_info(year)$file_name ) %>% 
    get_census_tot_pop(year_num = get_census_csv_file_info(year)$year_num, by_race = FALSE)
  
  return(pop)
}
```

## function to process mortality data for v148

```{r}
process_mort <- function(year, icd){
  
  print(get_mort_file_name(year))
  
  mort <- read_mort_data(
    file_path = file.path(nchs_mort_dir, get_mort_file_name(year) ), 
    header = mort_header,
    n_max = Inf) %>% 
    glimpse() %>% 
    get_mort_filtered_by_icd(df_fips=fips, icd, by_race = FALSE)
  
  return(mort)
}
```

# pop 2019-2023
for 2022 and 2023 the CT population values need to be replaced with those from 2021 (The last year of the old fips) 

for the 2026 release we don't have CT planning regions so we have to use the "old" fipscodes  

```{r}

pop_all = bind_rows(
  process_pop(2019), 
  process_pop(2020), 
  process_pop(2021), 
  process_pop(2022) %>% fix_CT_pop(process_pop(2021)),
  process_pop(2023) %>% fix_CT_pop(process_pop(2021))
  )%>% 
  group_by(statecode, countycode) %>% 
  summarise(pop = sum(pop), .groups = "drop") %>% 
  filter(!(statecode == "02" & countycode == "261") ) %>% # remove 02261
  # remove 09001, 09003, ..., 09015
  # remove 09110, 09120, 09130, ...., 09190 
  filter(!(statecode == "09" & countycode %in% str_pad(as.character(seq(11, 19, 1)), 3, "right", "0") )) %>%
  glimpse()


```




# NCHS mort data 

## header

```{r}
mort_header <- tribble(
  ~fld_name, ~start,  ~end,
  "state_of_residence", 29,  30,
  "county_of_residence", 35,  37,
  "icd_code", 146, 149
)
```

## icd codes for v135

```{r}
icd_code_lst <- icd_codes_v135()

```


## mort 5 years
```{r}
mort_all <- bind_rows(
  c(2019:2023) %>% 
    map(~process_mort(year = ., icd_code_lst))
  ) %>% 
  group_by(statecode, countycode) %>% 
  summarise(deaths = sum(deaths), .groups = "drop")

```

# mortality calculation

## merge mort and pop data

```{r}
merged <- pop_all %>% 
  left_join(mort_all, 
            by = c("statecode", "countycode"))
  
```

## confidence Intervals

```{r}
v135 <- merged %>%
  rename(numerator = deaths, denominator = pop) %>%
  mutate(
    rawvalue = numerator / denominator *100000,
    rse = 100 * sqrt(1/numerator),
  ) %>%
  mutate(
    std = rawvalue * rse / 100,
    cilow = rawvalue - 1.96 * std,
    cihigh = rawvalue + 1.96 * std
  ) %>%
  select(-c(rse, std))

```

## calculate CI L and U for n < 100

```{r}
suppress_limit <- 10

v135_2 <- v135 %>% 
  left_join(get_pois_CI(), by = c("numerator" = "n")) %>% 
  mutate(cilow = if_else(numerator>= suppress_limit & numerator <=99,
                         rawvalue * L, cilow),
         cihigh = if_else(numerator>=suppress_limit & numerator <=99,
                         rawvalue * U, cihigh)) %>% 
  select(-c(L, U)) %>% 
  mutate(across(where(is.numeric), ~ if_else(numerator < suppress_limit, 
                                            NA_real_, .x))) %>% 
  mutate(sourceflag  = NA_real_) %>% 
  rename_with(.fn = ~paste0("v135_", .x), .cols = c("denominator", "numerator","rawvalue", "cilow" , "cihigh" ,"sourceflag"))

```

# standardize FIPS add flag_CT

```{r}
v135_3 <- fips %>%
  select(statecode, countycode) %>%
  left_join(v135_2, by = c("statecode", "countycode")) %>%
  add_flag_CT(vnum="v135", old = "U", new = "A")

```

# compare initial and duplicated calculations 
```{r}
compare("v135", v135_3, 2026)
```


# save data
```{r}
save_data(v135_3, "v135")
```
