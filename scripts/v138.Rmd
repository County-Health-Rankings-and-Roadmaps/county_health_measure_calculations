---
title: "v138 Drug overdose deaths - R2025"
author: "GL"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# about

## Basic information

- Description
Number of drug poisoning deaths per 100,000 population.

- What is the numerator?
The numerator includes deaths from accidental, intentional, and undetermined drug poisoning by and exposure to: 1) nonopioid analgesics, antipyretics and antirheumatics, 2) antiepileptic, sedative-hypnotic, antiparkinsonism and psychotropic drugs, not elsewhere classified, 3) narcotics and psychodysleptics (hallucinogens), not elsewhere classified, 4) other drugs acting on the autonomic nervous system, and 5) other and unspecified drugs, medicaments and biological substances, over a 3-year period. ICD-10 codes used include X40-X44, X60-X64, X85, and Y10-Y14.

- What is the denominator?
The denominator is the aggregate annual population over the three-year period.

## Raw data access

- NCHS mortality and natality data 2020-2022: the data is requested

- Connecticut mortality data: data is requested; for new CT counties (i.e., planning regions)

- Census population estimates 2020-2022 from: https://www2.census.gov/programs-surveys/popest/datasets

# import packages

```{r}
library(tidyverse)
library(haven)
```

# set up directory

```{r}
# set up directory that holds data needed for calculations
# NCHS mortality data, not allowed to share in GitHub
nchs_mort_dir <- "C:/01_CHRR/data/NCHS_2023-10-04/mort2016_2021"

# NCHS natality data, not allowed to share in GitHub
nchs_nata_dir <- "C:/01_CHRR/data/NCHS_2023-10-04/nat2016_2022"

# Census county population estimates data
census_pop_dir <- "C:/01_CHRR/data/Census_county_pop_est"

# Connecticut mortality data, not allowed to share in GitHub
CT_mort_dir <- "C:/01_CHRR/data/CT_mortality"
```

# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r }
fips <-  bind_rows(
  read_sas("../inputs/county_fips_with_ct_old.sas7bdat"),
  read_sas( "../inputs/state_fips.sas7bdat")) %>% 
  arrange(statecode, countycode) %>% 
  glimpse()

```

# helpers

## functions used commonly by NCHS measures

- some commonly used functions are in a separate file, `nchs_measure_helpers.R`. 
```{r}
source("../scripts/nchs_measure_helpers.R")
```

## function to process pop data for v138

```{r}
process_pop <- function(year){
  
  pop <- read_census_pop(file_name = get_census_csv_file_info(year)$file_name ) %>% 
    get_census_tot_pop(year_num = get_census_csv_file_info(year)$year_num, by_race = FALSE)
  
  return(pop)
}
```

## function to process mortality data for v138

```{r}
process_mort <- function(year, icd){
  
  print(get_mort_file_name(year))
  
  mort <- read_mort_data(
    file_path = file.path(nchs_mort_dir, get_mort_file_name(year) ), 
    header = mort_header,
    n_max = Inf) %>% 
    glimpse() %>% 
    get_mort_filtered_by_icd(df_fips=fips, icd, by_race = FALSE)
  
  return(mort)
}
```

# pop 2020-2022

```{r}
pop_all <- bind_rows(
  c(2020:2022) %>% 
    map(~process_pop(year = .)) 
  ) %>% 
  group_by(statecode, countycode) %>% 
  summarise(pop = sum(pop), .groups = "drop") %>% 
  filter(!(statecode == "02" & countycode == "261") ) %>% # remove 02261
  # remove 09001, 09003, ..., 09015
  filter(!(statecode == "09" & countycode %in% str_pad(as.character(seq(1, 15, 2)), 3, "left", "0") )) %>%
  glimpse()
```

## use 2022 pop for new CT planning regions

- The new Connecticut counties only have 2022 population estimates. Their 3-year population is approximated by multiplying the 2022 value by 3. The state total uses actual annual estimates for each of the 3 years.

```{r}
pop_all_2 <- 
  update_pop_CT_new(pop_all, num_yrs = 3, state = FALSE) %>% # set state=FALSE if we want to keep CT state pop same as Census pop estimates, TRUE if we want fabricated CT state pop
  glimpse()
```

# NCHS mort data 

## header

```{r}
mort_header <- tribble(
  ~fld_name, ~start,  ~end,
  "state_of_residence", 29,  30,
  "county_of_residence", 35,  37,
  "icd_code", 146, 149
)
```

## icd codes for v138

```{r}
icd_code_lst <- c('X40', 'X41', 'X42', 'X43', 'X44', 'X60', 'X61', 'X62', 'X63', 'X64', 'X85', 
				'Y10', 'Y11', 'Y12', 'Y13', 'Y14')

```

## mort data: NCHS 2020-2022
```{r}
mort_all <- bind_rows(
  c(2020:2022) %>% 
    map(~process_mort(year = ., icd_code_lst))
  ) %>% 
  group_by(statecode, countycode) %>% 
  summarise(deaths = sum(deaths), .groups = "drop") 

```


# CT mort data for CT new counties

## import data 2016-2022

```{r}
CT_mort_2016to2022 <- read_csv(file.path(CT_mort_dir, "CT_mort_2016to2022.csv")) %>% 
  select(year = DTHYR, state = STRESIDF, countycode = CEPR_RES, age = Age_Years, icd_code = PCAUSE, RACE6_ETH )
```

## CT mort data for new counties

```{r}
CT_mort_new <- 
  get_CT_from_CT_mort(CT_mort_2016to2022, year_lst = 2020:2022, icd_code_lst=icd_code_lst)
```

## update mort_all with only new CT counties or with both CT county and state data

```{r}
mort_all_2 <- 
  update_mort_CT_new(mort_all, CT_mort_new, state = FALSE) 
```

# mortality calculation

## merge mort and pop data

```{r}
merged <- pop_all_2 %>% 
  left_join(mort_all_2, 
            by = c("statecode", "countycode"))
  
```

## confidence Intervals

```{r}
v138 <- merged %>%
  rename(numerator = deaths, denominator = pop) %>%
  mutate(
    rawvalue = numerator / denominator *100000,
    rse = 100 * sqrt(1/numerator),
  ) %>%
  mutate(
    std = rawvalue * rse / 100,
    cilow = rawvalue - 1.96 * std,
    cihigh = rawvalue + 1.96 * std
  ) %>%
  select(-c(rse, std))

```

## calculate CI L and U for n < 100

```{r}
suppress_limit <- 10

v138_2 <- v138 %>% 
  left_join(get_pois_CI(), by = c("numerator" = "n")) %>% 
  mutate(cilow = if_else(numerator>= suppress_limit & numerator <=99,
                         rawvalue * L, cilow),
         cihigh = if_else(numerator>=suppress_limit & numerator <=99,
                         rawvalue * U, cihigh)) %>% 
  select(-c(L, U)) %>% 
  mutate(across(where(is.numeric), ~ if_else(numerator < suppress_limit, 
                                            NA_real_, .x))) %>% 
  mutate(sourceflag  = NA_real_) %>% 
  rename_with(.fn = ~paste0("v138_", .x), .cols = c("denominator", "numerator","rawvalue", "cilow" , "cihigh" ,"sourceflag"))


```

# standardize FIPS add flag_CT

```{r}
v138_3 <- fips %>%
  select(statecode, countycode) %>%
  left_join(v138_2, by = c("statecode", "countycode")) %>%
  add_flag_CT(vnum="v138", old = "U", new = "A")

```

# save data
```{r}
save_data(v138_3, "v138")
```
