---
title: "v167 school segregation - R2025"
author: "how"
format: html
editor: visual
---

### state values are currently missing from this code - need to update!!!! 

# Description:

The extent to which students within different race and ethnicity groups are unevenly distributed across schools when compared with the racial and ethnic composition of the local population. The index ranges from 0 to 1 with lower values representing a school composition that approximates race and ethnicity distributions in the student populations within the county, and higher values representing more segregation.

# Data Source:

National Center for Education Statistics

Data Download Link: <http://nces.ed.gov/ccd/elsi/tableGenerator.aspx>

### Directions for dowloading data:

Select a Table Row: "Public School"

Select Years: "2023-2024"

Select Table Columns: categories are bolded

#### Information/Basic Information

State Name \[Public School\]

Latest available year School Name \[Public School\] 2023-24

County Name \[Public School\] 2023-24

County Number \[Public School\] 2023-24

#### Characteristics/School-District Classification Information

School Type \[Public School\] 2023-24

Start of Year Status \[Public School\] 2023-24

#### Enrollments/Total Enrollment

Total Students All Grades (Excludes AE) \[Public School\] 2023-24

#### Enrollments/Enrollment by Race/Ethnicity

American Indian/Alaska Native Students \[Public School\] 2023-24

Asian or Asian/Pacific Islander Students \[Public School\] 2023-24

Hispanic Students \[Public School\] 2023-24

Black or African American Students \[Public School\] 2023-24

White Students \[Public School\] 2023-24

Nat. Hawaiian or Other Pacific Isl. Students \[Public School\] 2023-24

Two or More Races Students \[Public School\] 2023-24

Select Filters (Refinements): Can leave without altering.

Click "Create Table"

## How do we calculate this measure?

### 1. The following school types are excluded:

school_name: JUVENILE, JAIL, PRISON, CORRECTIONAL, VIRTUAL, CYBER

School_Type\_\_Public_School\_\_2023: 4-Alternative Education School';

Start_of_Year_Status\_\_Public_Sch: '6-Inactive' or '2-Closed'

Total Student population == 0

### 2. Create proportions for each race/ethnicity category:

amer_ind_prop = AIAN_students/Total_Students

asian_pi_haw_prop = (Asian_PI_students+Hawaiian_students)/Total_Students

hispanic_prop = Hispanic_students/Total_Students

black_prop = Black_students/Total_Students

white_prop = White_students/Total_Students

two_prop = Two_or_more_students/Total_Students

If a race/ethnicity group is missing, set that student population to 0.

### 3. Calculate a theil value for each school:

theil_school = -(amer_ind_prop \* log(ifn(amer_ind_prop=0, 1, amer_ind_prop)) + asian_pi_haw_prop \* log(ifn(asian_pi_haw_prop=0, 1, asian_pi_haw_prop)) + hispanic_prop \* log(ifn(hispanic_prop=0, 1, hispanic_prop)) + black_prop \* log(ifn(black_prop=0, 1, black_prop)) + white_prop \* log(ifn(white_prop=0, 1, white_prop)) + two_prop \* log(ifn(two_prop=0, 1, two_prop)))

(function ifn() is used to avoid log0)

### 4. Calculate a theil value for each county:

theil_county = aggregate school values for each race/ethnicity category and complete the same calculation as above for theil_school

### 5. Calculate a school_weight, theil_school_weight, and a theil_county_weight:

school_weight = Total_students_in_school/Total_students_in_county

theil_school_weight = theil_school\*school_weight

theil_county_weight = aggregating the theil_school_weight for each county

### 6. Use the below formula to create the final theil value for each county:

theil_county_final = abs(theil_county-theil_county_weight)/theil_county

Then suppress counties where only one race/ethnicty category has 25 or more students or where there is only one school

### 7. Follow the same process as above for calculating state values.

It might be easiest to start with the dataset that is used to aggregate student populations by race/ethnicity group from school-level to county-level. Then follow steps 2-6 above.

# import packages

```{r}
library(tidyverse)
library(readxl)
library(haven) 

```

# standard county and state fips

The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.

```{r}
fips <-  bind_rows(
  read_sas(here("inputs/county_fips_with_ct_old.sas7bdat")) ,
  read_sas(here("inputs/state_fips.sas7bdat")))  %>% 
  arrange(statecode, countycode) %>% 
  glimpse()
```

# Load raw data

```{r}
raw = read.csv(here("raw_data/ELSI/ELSI_csv_export.csv"), skip = 6)
```

# some clean up

also calculate school proportions and theil_school values

```{r}
raw_formatted = raw %>%
  filter(!grepl("JUVENILE|JAIL|PRISON|CORRECTIONAL|VIRTUAL|CYBER", School.Name, ignore.case = TRUE)) %>% 
  filter(School.Type..Public.School..2023.24 != "4-Alternative Education School") %>% 
  filter(!(Start.of.Year.Status..Public.School..2023.24 %in% c("6-Inactive", "2-Closed"))) %>% 
  filter(Total.Students.All.Grades..Excludes.AE...Public.School..2023.24 != 0) %>% 
  filter(!(Total.Students.All.Grades..Excludes.AE...Public.School..2023.24 %in% c("–","†", "‡"))) %>% #need to add this to admin 
  filter(Start.of.Year.Status..Public.School..2023.24 != "7-Future") %>% #need to add this to admin 
  filter(!is.na(County.Number..Public.School..2023.24)) %>% #gotta add to admin 
  mutate(fipscode = str_pad(County.Number..Public.School..2023.24, width = 5, side = "left", pad = "0"), 
         statecode = substr(fipscode, 1,2), 
         countycode = substr(fipscode, 3,5),
         
         # Replace special characters such as '†' and '‡' and '-' with NA
         n_school = str_replace_all(Total.Students.All.Grades..Excludes.AE...Public.School..2023.24, "[†‡-]", NA_character_),
         n_amer_ind = str_replace_all(American.Indian.Alaska.Native.Students..Public.School..2023.24, "[†‡-]", NA_character_),
         n_haw = str_replace_all(Nat..Hawaiian.or.Other.Pacific.Isl..Students..Public.School..2023.24, "[†‡-]", NA_character_),
         n_asian_pi = str_replace_all(Asian.or.Asian.Pacific.Islander.Students..Public.School..2023.24, "[†‡-]", NA_character_),
         n_hispanic = str_replace_all(Hispanic.Students..Public.School..2023.24, "[†‡-]", NA_character_),
         n_black = str_replace_all(Black.or.African.American.Students..Public.School..2023.24, "[†‡-]", NA_character_),
         n_white = str_replace_all(White.Students..Public.School..2023.24, "[†‡-]", NA_character_),
         n_two = str_replace_all(Two.or.More.Races.Students..Public.School..2023.24, "[†‡-]", NA_character_),
         
         
         
         # Convert to numeric and replace NA with 0
         n_school = coalesce(as.numeric(n_school), 0), 
         n_amer_ind = coalesce(as.numeric(n_amer_ind), 0),
         n_asian_pi_haw = coalesce(as.numeric(n_asian_pi),0) + coalesce(as.numeric(n_haw),0),
         n_hispanic = coalesce(as.numeric(n_hispanic), 0),
         n_black = coalesce(as.numeric(n_black), 0),
         n_white = coalesce(as.numeric(n_white), 0),
         n_two = coalesce(as.numeric(n_two), 0),
         
         
         amer_ind_prop = n_amer_ind/n_school,  
         asian_pi_haw_prop = n_asian_pi_haw/n_school, 
         hispanic_prop = n_hispanic/n_school,  
         black_prop = n_black/n_school, 
         white_prop = n_white/n_school, 
         two_prop = n_two/n_school,
         
         theil_school = -(amer_ind_prop * log(ifelse(amer_ind_prop==0, 1, amer_ind_prop)) + 
                            asian_pi_haw_prop * log(ifelse(asian_pi_haw_prop==0, 1, asian_pi_haw_prop)) + 
                            hispanic_prop * log(ifelse(hispanic_prop==0, 1, hispanic_prop)) + 
                            black_prop * log(ifelse(black_prop==0, 1, black_prop)) + 
                            white_prop * log(ifelse(white_prop==0, 1, white_prop)) + 
                            two_prop * log(ifelse(two_prop==0, 1, two_prop)))
         ) 
```

# agregate to the county level

```{r}
theil_county = raw_formatted %>% group_by(statecode, countycode) %>% 
  mutate(
    
    nc_totalstudents = sum(n_school, na.rm = TRUE),
    nc_amer_ind = coalesce(sum(n_amer_ind, na.rm = TRUE), 0),  
    nc_asian_pi_haw = coalesce(sum(n_asian_pi_haw, na.rm = TRUE), 0),  
    nc_hispanic = coalesce(sum(n_hispanic, na.rm = TRUE), 0),   
    nc_black = coalesce(sum(n_black, na.rm = TRUE), 0),  
    nc_white = coalesce(sum(n_white, na.rm = TRUE), 0),  
    nc_two = coalesce(sum(n_two, na.rm = TRUE), 0), 
    
    amer_ind_propc = nc_amer_ind/nc_totalstudents,  
    asian_pi_haw_propc = nc_asian_pi_haw/nc_totalstudents, 
    hispanic_propc = nc_hispanic/nc_totalstudents,  
    black_propc = nc_black/nc_totalstudents, 
    white_propc = nc_white/nc_totalstudents, 
    two_propc = nc_two/nc_totalstudents, 
    
    theil_county =  -(amer_ind_propc * log(ifelse(amer_ind_propc==0, 1, amer_ind_propc)) + 
                        asian_pi_haw_propc * log(ifelse(asian_pi_haw_propc==0, 1, asian_pi_haw_propc)) + 
                        hispanic_propc * log(ifelse(hispanic_propc==0, 1, hispanic_propc)) + 
                        black_propc * log(ifelse(black_propc==0, 1, black_propc)) + 
                        white_propc * log(ifelse(white_propc==0, 1, white_propc)) + 
                        two_propc * log(ifelse(two_propc==0, 1, two_propc)))
      )
      
```

# combine school and county level

```{r}

theiltot = theil_county %>% mutate(
  school_weight = n_school / nc_totalstudents,
  theil_school_weight = theil_school*school_weight 
) 

theilf = theiltot %>% 
  group_by(statecode, countycode) %>% 
  mutate(
    theil_county_weight = sum(theil_school_weight, na.rm = TRUE),
    theil_county_final = ifelse(
      rowSums(cbind(nc_amer_ind >= 25, nc_asian_pi_haw >= 25, nc_hispanic >= 25, 
                                               nc_black >= 25, nc_white >= 25, nc_two >= 25)) >1 & 
        n()>1,
                                abs(theil_county - theil_county_weight)/theil_county, 
      NA)
    )

# make final dataset 

schoolseg = theilf %>% group_by(statecode, countycode) %>% select(theil_county_final) %>% distinct() %>% 
  rename(v067_rawvalue = theil_county_final) 

# merge with chrr fipscodes 

schoolseg_f = merge(schoolseg, fips, by = c("statecode", "countycode"), all.y = TRUE)

```

# save data

```{r}
write.csv(schoolseg, file = here("measure_datasets/v167_r2025.csv"), row.names = FALSE)
```
