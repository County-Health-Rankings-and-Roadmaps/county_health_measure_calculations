---
title: "v015 Homicides - Ranking 2026"
author: "GL (updated by how for the 2026 release)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# about

## Basic information

- Description
Number of deaths due to homicide per 100,000 population.

- What is the numerator?
The numerator is the number of deaths in a county over the seven-year period due to homicide as defined by ICD-10 codes X85-Y09 (assault).

- What is the denominator?
The denominator is the aggregate county population over the seven-year period.

## Raw data access

- NCHS mortality and natality data 2017-2023: the data is requested

- Census population estimates 2017-2023 from: https://www2.census.gov/programs-surveys/popest/datasets

# import packages

```{r}
library(tidyverse)
library(haven)
```

# set up directory

```{r}
# set up directory that holds data needed for calculations
# NCHS mortality data, not allowed to share in GitHub
nchs_mort_dir <- "D:/CHRR/mortality raw"

# NCHS natality data, not allowed to share in GitHub
nchs_nata_dir <- "D:/CHRR/natality raw"

# Census county population estimates data
census_pop_dir <- "D:/CHRR/pop raw"
```

# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r }
fips <-  bind_rows(
  read_sas("../inputs/county_fips_with_ct_old.sas7bdat"),
  read_sas( "../inputs/state_fips.sas7bdat")) %>% 
  arrange(statecode, countycode) %>% 
  glimpse()

```

# helpers

## functions used commonly by NCHS measures

- some commonly used functions are in a separate file, `nchs_measure_helpers.R`. 
```{r}
source("../scripts/nchs_measure_helpers.R")
```

## function to process pop data for v015

```{r}
process_pop <- function(year){
  
  pop <- read_census_pop(file_name = get_census_csv_file_info(year)$file_name ) %>% 
    get_census_tot_pop(year_num = get_census_csv_file_info(year)$year_num, by_race = FALSE)
  
  return(pop)
}
```

## function to process mortality data for v015

```{r}
process_mort <- function(year, icd){
  
  print(get_mort_file_name(year))
  
  mort <- read_mort_data(
    file_path = file.path(nchs_mort_dir, get_mort_file_name(year) ), 
    header = mort_header,
    n_max = Inf) %>% 
    glimpse() %>% 
    get_mort_filtered_by_icd(df_fips=fips, icd, by_race = FALSE)
  
  return(mort)
}
```

# pop 2017-2023

```{r}
pop_all <- bind_rows(
  c(2017:2021) %>% 
    map(~process_pop(year = .)),
  process_pop(2022) %>% 
    fix_CT_pop(process_pop(2021)),
  process_pop(2023) %>% 
    fix_CT_pop(process_pop(2021))
  ) %>% 
  group_by(statecode, countycode) %>% 
  summarise(pop = sum(pop), .groups = "drop") %>% 
  filter(!(statecode == "02" & countycode == "261") ) %>% # remove 02261
  glimpse()
```


# NCHS mort data 

## header

```{r}
mort_header <- tribble(
  ~fld_name, ~start,  ~end,
  "state_of_residence", 29,  30,
  "county_of_residence", 35,  37,
  "icd_code", 146, 149
)
```

## icd codes for v015

```{r}
icd_code_lst <- c('X85', 'X86', 'X87', 'X88', 'X89','X90', 'X91', 'X92', 'X93', 
                  'X94', 'X95', 'X96', 'X97', 'X98', 'X99', 'Y00', 'Y01', 'Y02', 
                  'Y03', 'Y04', 'Y05', 'Y060', 'Y061', 'Y062', 'Y068', 'Y069',
                  'Y070', 'Y071', 'Y072', 'Y073', 'Y078', 'Y079', 'Y08', 'Y09')

```


## mort data: NCHS 2017-2023

```{r}
mort_all <- bind_rows(
  c(2017:2023) %>% 
    map(~process_mort(year = ., icd_code_lst))
  ) %>% 
  group_by(statecode, countycode) %>% 
  summarise(deaths = sum(deaths), .groups = "drop") 

```



# mortality calculation

## merge mort and pop data

```{r}
merged <- pop_all %>% 
  left_join(mort_all, 
            by = c("statecode", "countycode"))
  
```

## confidence Intervals

```{r}
v015 <- merged %>%
  rename(numerator = deaths, denominator = pop) %>%
  mutate(
    rawvalue = numerator / denominator *100000,
    rse = 100 * sqrt(1/numerator),
  ) %>%
  mutate(
    std = rawvalue * rse / 100,
    cilow = rawvalue - 1.96 * std,
    cihigh = rawvalue + 1.96 * std
  ) %>%
  select(-c(rse, std)) 

```

## calculate CI L and U for n < 100

```{r}
suppress_limit <- 10

v015_2 <- v015 %>% 
  left_join(get_pois_CI(), by = c("numerator" = "n")) %>% 
  mutate(cilow = if_else(numerator>= suppress_limit & numerator <=99,
                         rawvalue * L, cilow),
         cihigh = if_else(numerator>=suppress_limit & numerator <=99,
                         rawvalue * U, cihigh)) %>% 
  select(-c(L, U)) %>% 
  mutate(across(where(is.numeric), ~ if_else(numerator < suppress_limit, 
                                            NA_real_, .x))) %>% 
  mutate(sourceflag  = NA_real_) %>% 
  rename_with(.fn = ~paste0("v015_", .x), .cols = c("denominator", "numerator","rawvalue", "cilow" , "cihigh" ,"sourceflag"))

```

# standardize FIPS add flag_CT

```{r}
v015_3 <- fips %>%
  select(statecode, countycode) %>%
  left_join(v015_2, by = c("statecode", "countycode")) %>%
  add_flag_CT(vnum="v015", old = "U", new = "A")

```


# Compare to initial calculations 
```{r}
compare("v015", v015_3, year = 2026)
```

# save data
```{r}
save_data(v015_3, "v015")
```
