---
title: "v133_r2025"
author: how
format: html
editor: visual
---

## Description: 
Index of factors that contribute to a healthy food environment, from 0 (worst) to 10 (best). 

## Numerator: 
Percentage of residents with limited access to healthy food (ie measure v083)

## Denominator: 
Percentage of individuals who are food insecure (ie measure v139)

## Data Source: 
USDA Food Environment Atlas
Map the Meal Gap from Feeding America 

## Data Download Link: 
USDA - https://www.ers.usda.gov/data-products/food-access-research-atlas/download-the-data/

Map the Meal Gap: https://map.feedingamerica.org/ 
This data has to be requested via this request form: https://feedingamerica.az1.qualtrics.com/jfe/form/SV_5tJt5m9K62hRC6N  

## Notes: 
Data from MMG 2020 and beyond are NOT directly comparable to data from any prior MMG study due to methodological changes made in 2020.

Feeding America made two improvements to the model used to estimate local food insecurity. Our estimates now account for disability status and reflect a refined definition of poverty. These changes both improve the accuracy of our estimates and align the model with the most up-to-date research on the key determinants of food insecurity.

We do not recommend comparing food insecurity estimates from Map the Meal Gap 2020 (2018 data) or later releases to data from Map the Meal Gap 2019 (2017 data) or any previous year due to changes in the methodology made in 2020 (i.e., updated poverty variable and new disability variable). However, estimates from Map the Meal Gap 2013 (2011 data) through Map the Meal Gap 2019 (2017 data) are more directly comparable.


## Caculating this measure: 

Limited Access to Healthy Food: The % with limited access to healthy foods is the "numerator."
Use variables LALOWI1_10/Pop2010 to calculate Limited Access to Healthy Foods
(This is the same as measure v083 - limited access to healthy foods. So instead of downloading data from the source, it is possible to use data from folder three for v083 if it has already been verified.) 

Food Insecurity: The % considered food insecure is the "denominator."
Use column titled "Overall Food Insecurity Rate (1 year)" and column titled "Year" (for 2022)
(This is the same as measure v139 - food insecurity. So instead of downloading data from the source, it is possible to use data from folder three for v139 if it has already been verified.) 


Create variable fipscode = statecode||countycode to merge datasets

Create national z-scores using county-level data for each of the 2 measures (i.e., exclude rows for state and national values in this calculation). 

     a) The z score for the numerator: (numeratorvalue – averagenumvalue)/numSD

     b) The z score for the denominator: (denomvalue – averagedenomvalue)/denomSD

     c) Be sure that a missing value in the numerator or denominator equates to a missing z score for the numerator or denominator.

HOWEVER, all available data should be used in each zscore calculation; i.e., if a numerator is missing, the denominator should not be set missing until AFTER zscore calculations are complete. 

Use the mean of the two z-scores to create a combined z score for a county. This will be used to create an index.

     a) For counties the combined z score is considered at the national level. Accordingly, the county-level combined z score is simply the mean of the numerator and denominator z scores. Be sure that any missing values result in the combined z score also being missing: combinedz = (znumerator + zdenominator)/2 or zscore = mean(z_v133_numerator, z_v133_denominator); 

Create an index so that the overall county with the lowest (most negative) z-score receives a 10 value (best) on the index and the county with the highest z-score receives a 0 (worst) on the index. This index will be named v133_rawvalue.

     a) Determine the minimum, maximum and range of the completed combined z score variable.

     b) The unrounded index value: unrounded = (((max - v133_combined)/(range))*10);

     c) Account for missing values.

     d) Round so that the precision is to the tenths place: v133_rawvalue = round(unrounded, 0.1)

Repeat steps 4 and 5 for state and national level data (i.e., create one data set with rows for state and national values). Then use the formula derived in 6.b. from the county-level data when calculating state and national level indices.

Combine the two data sets, i.e., county data set and state/national level data set.

The final form of the dataset at this stage should include the Statecode, Countycode, numerator, denominator, rawvalue, cilow (missing), cihigh (missing), sourceflag (missing) named according to the standard measure fashion.

# import packages

```{r}
library(tidyverse)
library(readxl)
library(haven)
library(stringr)
library(here)
```

# standard county and state fips

-   The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.

```{r}
fips <-  bind_rows(
  read_sas(here("inputs/county_fips_with_ct_old.sas7bdat")) ,
  read_sas(here("inputs/state_fips.sas7bdat")))  %>% 
  arrange(statecode, countycode) %>% 
  glimpse()
```

# load data
In this case there is no "raw" data since this measure can be calculated from measures v139 and v083. We pull from the measure_datasets folder instead. 
```{r}
# get verified measures from measure_datasets folder  

#food insecurity 
fi = read.csv(here("measure_datasets/v139_r2025.csv")) 

#limited access to healthy food 
la = read.csv(here("measure_datasets/v083_r2025.csv")


# merge the two 
fila = merge(fi, la, by = c("statecode", "countycode"), all.x = TRUE)

```

# Do the county level calculations 
```{r}
countylevel = fila %>% filter(countycode != "000") %>% 
  mutate(zdenom = ifelse(!is.na(v139_rawvalue), 
                         (v139_rawvalue - mean(v139_rawvalue, na.rm = TRUE)) / sd(v139_rawvalue, na.rm = TRUE), 
                         NA), 
         znum = ifelse(!is.na(v083_rawvalue), 
                       (v083_rawvalue - mean(v083_rawvalue, na.rm = TRUE)) / sd(v083_rawvalue, na.rm = TRUE), 
                       NA),
        combinedz = (znum + zdenom)/2)
      
```

# Do the state level calculations 

```{r}
statelevel = fila %>% filter(countycode == "000") %>% 
 mutate(  # Using reframe instead of summarize to avoid the deprecation warning
    zdenom = ifelse(!is.na(v139_rawvalue), 
                    (v139_rawvalue - mean(v139_rawvalue, na.rm = TRUE)) / sd(v139_rawvalue, na.rm = TRUE), 
                    NA), 
    znum = ifelse(!is.na(v083_rawvalue), 
                  (v083_rawvalue - mean(v083_rawvalue, na.rm = TRUE)) / sd(v083_rawvalue, na.rm = TRUE), 
                  NA),
    combinedz = (znum + zdenom) / 2)
```

# Calculate rawvalues 

```{r}
# get the max and min county level combinedz 
maxvalue = max(countylevel$combinedz, na.rm = TRUE) 
minvalue = min(countylevel$combinedz, na.rm = TRUE)


sc = rbind(countylevel, statelevel)

sc = sc %>% mutate(
  # Ensure no -Inf by excluding NA values
  # caclulate indices for states and counties 
    index = ifelse(!is.na(combinedz), 
                   (maxvalue - combinedz) / 
                     (maxvalue - minvalue) * 10, 
                   NA),
    v133_rawvalue = round(index, 1)
  ) %>% rename(v133_numerator = v083_rawvalue, 
               v133_denominator = v139_rawvalue)





v133 = sc %>% select(v133_rawvalue, statecode, countycode, v133_numerator, v133_denominator)

```

# save the measure_dataset 

```{r}
write.csv(v133, file = here("measure_datasets/v133_R2025.csv", row.names = FALSE)

```

