---
title: "v044 Income Inequality - R2025"
author: HOW 
format: html
editor: visual
---

# about

## Basic information

#### Description:

The ratio of household income at the 80th percentile to income at the 20th percentile

#### What is the numerator?

The numerator is the 80th percentile of median household income in a county. Income, defined as “total income,” is the sum of the amounts reported separately for wage or salary income; net self-employment income; interest, dividends, or net rental or royalty income or income from estates and trusts; Social Security or Railroad Retirement income; Supplemental Security Income (SSI); public assistance or welfare payments; retirement, survivor, or disability pensions; and all other income. Receipts from the following sources are not included as income: capital gains, money received from the sale of property (unless the recipient was engaged in the business of selling such property); the value of income “in kind” from food stamps, public housing subsidies, medical care, employer contributions for individuals, etc.; withdrawal of bank deposits; money borrowed; tax refunds; exchange of money between relatives living in the same household; gifts and lump-sum inheritances, insurance payments, and other types of lump-sum receipts.

#### What is the denominator?

The denominator is the 20th percentile of median household income in a county.

## Raw data access

-   Website to downloaded data

<https://data.census.gov/table?q=B19080&tid=ACSDT5Y2023.B19080>

Please refer to the page <https://www.census.gov/programs-surveys/acs/data/data-tables.html> or use any statistical package to retrieve table or data (<http://www.census.gov/programs-surveys/acs/data/summary-file.html>). Select table B19080 of the 2019-2023 ACS 5-year estimates.

rawvalue = 80th percentile median household income / 20th percentile median household income

rawvalue = upper limit 4th quintile / upper limit 1st quintile

-   Online documentation

<https://www.census.gov/programs-surveys/acs/technical-documentation.html>

### Note: the code below utilizes the Census API.
To run this code, you must first get your own Census API key by registering here: 
<https://api.census.gov/data/key_signup.html> 

This page has helpful examples for how the Census API works: 
<https://www.census.gov/data/developers/guidance/api-user-guide.Example_API_Queries.html#list-tab-559651575> 

#### Save your key here
Paste the long string of numbers and letters emailed to you by The Census Bureau API Team after the "&key=" below 
```{r}
key = "&key="

```


# import packages

```{r}
library(tidyverse)
library(readxl)
library(haven)
```


# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r}
fips <-  bind_rows(
  read_sas(here("inputs/county_fips_with_ct_old.sas7bdat")) ,
  read_sas(here("inputs/state_fips.sas7bdat")))  %>% 
  arrange(statecode, countycode) %>% 
  glimpse()
```

# get raw data from Census API 

```{r }
measurenum = "v044" #for col labels later 
acscolumns = c("B19080_001E", "B19080_001M", "B19080_004E", "B19080_004M")
apitype = "detailed" #other options include subject, profile, and comparison 
num = "B19080_004E" 
denom = "B19080_001E"
year = 2025 



colstring = paste0(acscolumns, collapse = ",")

#use year-2 since CHRR years are two years ahead of census data release years 
initial = paste0("https://api.census.gov/data/", year-2, "/acs/acs5")
typeurl = ifelse(apitype == "detailed", "?", 
                 ifelse(apitype == "subject", "/subject?", 
                        ifelse(apitype == "profile", "/profile?",
                               "/cprofile")))
urlc = paste0(initial, typeurl, "get=NAME,", colstring, "&for=county:*", key)
urls = paste0(initial, typeurl, "get=NAME,", colstring, "&for=state:*", key)
urln = paste0(initial, typeurl, "get=NAME,", colstring, "&for=us:1", key)

#load the county (c), state(s), and national(n) datasets using the urls we just built 
c = read.csv(urlc)
s = read.csv(urls)
n = read.csv(urln)

# set some standard conventions 
c$county = c$county.
s$state = s$state.
s$county = "000"
n$state = "00"
n$county = "000"

# combine the county data with the state data 
a = rbind(c[,intersect(colnames(c), colnames(s))], s[,intersect(colnames(c), colnames(s))])

# combine state and county data with national data 
b = rbind(a[,intersect(colnames(a), colnames(n))], n[,intersect(colnames(a), colnames(n))])

b$state = gsub("]", "", b$state)
b$statecode = stringr::str_pad(b$state, 2, side = "left", "0")
b$county = gsub("]","", b$county)
b$countycode = stringr::str_pad(b$county, 3, side = "left", "0")

b$num = b[,num]
b$denom = b[,denom]

# the following fips need update/correction 
# 02261 v-c -> 02063 chugach 
# 02261 v-c -> 02066 copper river



b$rawvalue = ifelse(b$num<250000, b$num/b$denom, NA)

#get standard error for calcing 95CIs 
b$sedenom = ifelse(b[,gsub("E", "M",denom)] >0, b[,gsub("E", "M",denom)]/1.645, NA) 
b$senum = ifelse(b[,gsub("E", "M",num)]>0, b[,gsub("E", "M",num)]/1.645, NA)

b$sep = (1/b$denom)*sqrt(b$senum^2 + b$rawvalue^2*b$sedenom^2)
b$cihigh = b$rawvalue +(1.96*b$sep)

b$cilow = ifelse(b$rawvalue -(1.96*b$sep)<0, 0, b$rawvalue - (1.96*b$sep))

# remove puerto rico and any other regions outside CHRR standard 51 states 
h = b[b$statecode <57,]

# remove excess cols 
hsub = h[,c("statecode", "countycode","num","denom","rawvalue","sep", "cilow", "cihigh")]


hf = merge(fips, hsub, by = c("statecode", "countycode"), all.x = TRUE)



#keep both old and new ct codes in the data
hf = hf %>% select(-c(state, county, fipscode, sep))


#make the column names prettier
colnames(hf) = c("statecode", "countycode", paste0(measurenum, "_numerator"), 
                   paste0(measurenum, "_denominator"), 
                   paste0(measurenum, "_rawvalue"), 
                   paste0(measurenum, "_cilow"),
                   paste0(measurenum, "_cihigh"))

```


## Save the data 
```{r}
write.csv(hf, file = here("measure_datasets/v044_r2025.csv"))
```

