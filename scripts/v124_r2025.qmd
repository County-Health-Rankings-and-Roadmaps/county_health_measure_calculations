---
title: v124 Drinking Water Violations 
format: html
author: HOW 
---

Description: Indicator of the presence of health-related drinking water violations. 'Yes' indicates the presence of a violation, 'No' indicates no violation.\

Data Source: Safe Drinking Water Information System\

Data Download Link: https://ofmpub.epa.gov/apex/sfdw/f?p=108:1:::NO:1::

The Envirofacts database is dynamic. Duplications should be completed using the same raw dataset as the initial calculations since additional downloads will result in differing datasets.

Go to: <https://ofmpub.epa.gov/apex/sfdw/f?p=108:1:::NO:1::>

Make sure that data are updated to Submission Year 2024 and Quarter 3.

2\. Select the following options to match the data:

-   Select a report: Violations

-   Submission year: 2024

-   Quarter: 3

-   Is Health Based: Yes

-   Compliance period begin date: January 1, 2023 – December 31, 2023

-   PWS Type: Community Water System

-   Activity Status: All

-   Everything else can remain in the default state

3\. Download the current geographic area file. Select the following options:

-   Select a report: Geographic Area

-   Submission year/quarter (same as violations: 2024 quarter 3)

-   Activity status: All

(Prior to rankings year 2021, we used the most recently available geography file which was not necessarily from the same time period (quarter 3) as the violations file. However, geography files appear to change over time, so it is important that the violations and geography files be from the same year and quarter.) 

4\. Merge violations file with geographic area file to assign county name and state to the water systems. 

Watch for missings in this step. For missings we checked by water system name and assigned manually. 

5\. Format county names to match CHR&R format and join with CHR&R FIPS code files. 

6\. Assign Yes/No values. 

**Note**:

-   It may take a few minutes to download data from the website.

-   It was noticed in 2023 that SDWIS updated their data system, and each row (corresponding to a water system) in the geographic area file was listed with one county only. (i.e., No need to fix situations where one water system was listed for multiple counties as in previous years)

-   It is feasible to extract data through Envirofacts Data Service AP. The API call did not work for downloading CSV files, but it worked for downloading xml files (need to convert xml to dataframe before saving as csv); however, calculations based on API data were different by a few counties from calculations based on data from their website. 

# import packages

```{r}
library(tidyverse)
library(haven)
library(here)

```

# standard county and state fips

-   The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.

```{r }
fips <-  bind_rows(
  read_sas(here("inputs/county_fips_with_ct_old.sas7bdat")) ,
  read_sas(here("inputs/state_fips.sas7bdat"))  %>% 
  arrange(statecode, countycode) %>% 
  glimpse())


```

```{r, echo = FALSE}
library(tidyverse)
viol = read.csv(here("raw_data/SDWIS/Violation Report.csv"))

names = read.csv(here("raw_data/SDWIS/Water System Geographic Area.csv"))



#assign viol=1 here so that viol=0 for counties in the named file but not in the viol file 
viol$viol = 1 

namesn = names %>% filter(`PWS.Type` == "Community water system")

#note that this filter can be done when downloading the raw names file itself 

violn = merge(viol, namesn, by = "PWS.ID", all = TRUE) #keep all such that named can be set to 0 

nojoin = dplyr::anti_join(viol, namesn, by = "PWS.ID") #all matched in the merge above 

violn$viol[is.na(violn$viol)] = 0
violn = violn %>% rename(state = `Primacy.Agency.y`, county = `County.Served`)

states = rbind(data.frame(stabb = state.abb, stname = state.name), c("DC", "District of Columbia"))
violns = merge(violn, states, by.x = "state", by.y = "stname", all.x = TRUE)
nojoin = dplyr::anti_join(violn, states, by = join_by("state" == "stname")) 
#lots of incorrect joins here - some (guam, PR, etc) are correctable and some may not be 

unique(nojoin$state)

violt= violn[!(violn$state %in% c("Guam", "Puerto Rico","American Samoa", "Northern Mariana Islands", "US Virgin Islands")),]
violns = merge(violt, states, by.x = "state", by.y = "stname", all.x = TRUE)
nojoin = dplyr::anti_join(violt, states, by = join_by("state" == "stname")) #still some incorrect joins here..... 
#unclear what to do with epa regions and navajo nation 


violns = violns %>% mutate(
  county = stringr::str_replace(county, " County", ""),
  county = str_replace(county, " Municipality", ""),
    county = str_replace(county, " Municipio", ""), 
    county = str_replace(county, " Census Area", ""),
    county = str_replace(county, " Borough", ""),
    county = str_replace(county, " Parish", ""), 
  county = str_replace(county, " and", ""),

   county = if_else(!(stabb %in% c("VA","MD", "NV")), str_replace(county, " City", ""), county),
  county = if_else(!(stabb %in% c("VA","MD", "NV")), str_replace(county, " city", ""), county),
  county = str_replace_all(county, "[[:space:]]", ""), 
  county= str_replace_all(county, '[[:punct:]]', ""), 
  stabb = if_else(state == "District of Columbia", "DC", stabb),
  county = if_else(county == "WadeHampton", "Kusilvak", county), 
  county = if_else(county == "Shannon" & stabb == "SD", "OglalaLakota", county), 
  county = if_else(county == "b", "Noble", county), #this one is special every time :') 
  county = str_to_lower(county)) %>% 
  filter(!is.na(county)) %>% 
  filter(!is.na(state))


violsum = violns %>% group_by(stabb, county) %>% summarize(nviol = sum(viol))




#need same steps as above to ensure a good match 
fips = fips %>% mutate(
   county = stringr::str_replace(county, " Planning Region", ""),
   county = stringr::str_replace(county, " County", ""),
  county = str_replace(county, " Municipality", ""),
  county = str_replace(county, " Municipio", ""), 
    county = str_replace(county, " Census Area", ""),
    county = str_replace(county, " Borough", ""),
    county = str_replace(county, " Parish", ""), 
  county = str_replace(county, " and", ""),
   county = if_else(!(state %in% c("VA","MD", "NV")), str_replace(county, " City", ""), county), #each of these three states has a "city" that needs to stay a city in order to not get confused w other counties of the same name 
  county = if_else(!(state %in% c("VA","MD", "NV")), str_replace(county, " city", ""), county),
  county = str_replace_all(county, "[[:space:]]", ""), 
  county= str_replace_all(county, '[[:punct:]]', ""), 
  county = str_to_lower(county))



violfips = merge(fips, violsum, by.y = c("stabb", "county"), by.x = c("state", "county"), all.x = TRUE, no.dups = TRUE)

nojoin = anti_join(violsum, fips, by = join_by("stabb" =="state", "county" == "county"))
# its okay that connecticut is here 
#its okay that bedfordcity is here since it gets set to NA later 
# need to check valdezcordova in AK 

nojoin = anti_join(fips, violsum, by = join_by("state" == "stabb", "county" == "county"))

missings = nojoin %>% filter(countycode != "000") %>% filter(as.numeric(fipscode) < 51200 | as.numeric(fipscode) > 53000) %>% filter(state != "HI")

# the counties above could not be found in the EPA geographic area file using the "county served" column....must look for them in the "city served" and "tribal description" columns instead 
# ct is not a concern since we will correct that separately 



#county "b" was manually set to noble above 
# and i will need to manually correct some special alaska counties 


# set some special stuff to missing 
# all HI counties should be set to missing 
violfips$nviol[violfips$state == "HI"] = NA

#Virginia cities should be set to missing as well since cities sit within counties which also have FIPS and we don't wish to double-count. Note: Charles city County and James city County are exceptions since they are cities that do not have a county that they sit within.
#the fipscodes for VA "cities" are from 51510 to 51840 

violfips$nviol[violfips$fipscode > 51200 & violfips$fipscode < 53000] = NA 
violfips$nviol[violfips$nviol>1] = 1
violfips$nviol[violfips$countycode == "000"] = NA

```

```{r}
#check all counties with NA 
# virginia, hawaii should be NA 
# we only want other NA if EPA does not collect data on those regions at all, otherwise, should be 0 

nas = violfips[is.na(violfips$nviol) & violfips$countycode != "000" & !(violfips$state %in% c("HI", "VA")),]

# per ganhua, we can use the city_served and tribal_description columns to verify that these counties are not assessed by the EPA 


# making a crude list by hand.... there are definitely better ways to do this...i need only the first/ partial word in order to find partial matches
# ignoring ct counties since those will be corrected separately 
# also checked "terry" since it is the county seat of prairie mt 
needcheck = c("chugach", "copper", "hoona", "petersburg", "prince", "carson", "menominee", "arthur", "loup", "mcpherson", "prairie")


# we mostly need to focus on carson city nv and menominee wi 
nv = sort(unique(violn$City.Served[violn$state == "Nevada"]))
#carson city is here 

#check the funky AK counties 
ak = sort(unique(violn$City.Served[violn$state == "Alaska"]))
# looks like petersburg is available here 
# valdez and cordova are here (separately)
# hoonah is here 
# hydaburg is here 
# 

matchcity = mapply(function(x, y) any(x %in% y), 
       needcheck, strsplit(tolower(namesn$City.Served), "\\s+"))

matchtrib = mapply(function(x, y) any(x %in% y), 
       needcheck, strsplit(tolower(namesn$Tribal.Description), "\\s+"))
  
tribmatch = namesn[matchtrib,] #looks like menominee is definitely included
citymatch = namesn[matchcity,] # looks like my matching isn't perfect since carson city isn't flagged here..... 


# for 2024 rankings GL and i decided that we could use the tribal info but not the city info (too much open to interpretation and cities != counties) to replace NA with 0..... 
# so menominee WI gets replaced with 0 since it seems like the EPA is collection data there / since menominee is included in the names file just labelled as a tribal area
# i searched the viol file separately to confirm that there were no violations assoc w menominee 

violfips$nviol[violfips$county == "menominee" & violfips$state == "WI"] = 0
```

```{r for ct specifically}

namesn = names %>% filter(`PWS.Type` == "Community water system")
namesct = namesn %>% filter(Primacy.Agency == "Connecticut" & !is.na(City.Served) & City.Served != "")


violct = viol %>% filter(Primacy.Agency.Code == "CT")

violctn = merge(violct, namesct, by = "PWS.ID") %>% mutate(City.Served = tolower(City.Served))


chrr = haven::read_sas(here("inputs/ct_town_county_crosswalk.sas7bdat")) %>% mutate(town_name = tolower(town_name))

violctchrr = merge(chrr, violctn, by.x = "town_name", by.y = "City.Served", all = TRUE)

ct = violctchrr %>% group_by(countycode_2022) %>% summarize(nviol = sum(viol, na.rm = TRUE)) %>% rename(countycode = countycode_2022)

ct$statecode = "09" 

ct$nviol[ct$nviol>1] = 1

```

```{r integrate new ct vals to final dataset }

# Update the nviol column in violfips with values from ct where they match
violfips_updated <- violfips %>%
  left_join(ct, by = c("statecode", "countycode"), suffix = c("", ".ct")) %>%
  mutate(nviol = ifelse(!is.na(nviol.ct), nviol.ct, nviol)) %>%
  select(-nviol.ct)
#note that baltimore county: 24005 should be double checked (it's fine here because i already corrected it above)
```


```{r}
v124 = violfips %>% select(statecode, countycode, nviol) %>% rename(v124_raw_value = nviol)
write.csv(v124, here("measure_datasets/v124_R2025.csv"))
```

My comments:

The "City Served" column should not be used at all to avoid potential misassignment: cities != counties

Names file should be pulled with PWS type = Community Water System specified (this is now indicated on admin)

Alaska is tricky...... will need to be very careful with missing versus 0 values in AK
