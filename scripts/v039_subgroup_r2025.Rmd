---
title: "v039 Motor vehicle crash deaths (subgroups) - R2025"
author: "GL"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# about

## Basic information

- Description
Number of motor vehicle crash deaths per 100,000 population.

- What is the numerator?
The numerator includes traffic accidents involving motorcycles, three-wheel motor vehicles, cars, vans, trucks, buses, street cars, ATVs, industrial, agricultural, and construction vehicles, and bicyclists or pedestrians when colliding with any of these vehicles, over a seven-year period (ICD10 codes: V02-V04 (.1, .9), V09.2, V12-V14 (.3-.9), V19 (.4-.6), V20-V28 (.3-.9), V29-V79 (.4-.9), V80 (.3-.5), V81.1, V82.1, V83-V86 (.0-.3), V87 (.0-.8), and V89.2). Deaths due to boating accidents and airline crashes are not included in the numerator.

- What is the denominator?
The denominator is the aggregate annual population over the seven-year period.

## Raw data access

- NCHS mortality and natality data 2016-2022: the data is requested

- Connecticut mortality data: data is requested; for new CT counties (i.e., planning regions)

- Census population estimates 2016-2022 from: https://www2.census.gov/programs-surveys/popest/datasets

## Subgroups

- non-Hispanic, White only, 
- non-Hispanic, Black only, 
- non-Hispanic, AIAN only, 
- non-Hispanic, Asian only, 
- non-Hispanic, NHOPI only, 
- non-Hispanic, Two or More Races
- Hispanic

# import packages

```{r}
library(tidyverse)
library(haven)
```

# set up directory

```{r}
# set up directory that holds data needed for calculations
# NCHS mortality data, not allowed to share in GitHub
nchs_mort_dir <- "C:/01_CHRR/data/NCHS_2023-10-04/mort2016_2021"

# NCHS natality data, not allowed to share in GitHub
nchs_nata_dir <- "C:/01_CHRR/data/NCHS_2023-10-04/nat2016_2022"

# Census county population estimates data
census_pop_dir <- "C:/01_CHRR/data/Census_county_pop_est"

# Connecticut mortality data, not allowed to share in GitHub
CT_mort_dir <- "C:/01_CHRR/data/CT_mortality"
```

# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r }
fips <-  bind_rows(
  read_sas("../inputs/county_fips_with_ct_old.sas7bdat"),
  read_sas( "../inputs/state_fips.sas7bdat")) %>% 
  arrange(statecode, countycode) %>% 
  glimpse()

```

# helpers

## functions used commonly by NCHS measures

- some commonly used functions are in a separate file, `nchs_measure_helpers.R`. 
```{r}
source("../scripts/nchs_measure_helpers.R")
```

## function to process pop data for v039

```{r}
process_pop_other <- function(year){
  
  pop <- read_census_pop(file_name = get_census_csv_file_info(year)$file_name ) %>% 
    get_census_tot_pop(year_num = get_census_csv_file_info(year)$year_num, by_race = TRUE)
  
  return(pop)
}
```

## function to process mortality data for v015

```{r}
process_mort_other <- function(year, icd){
  
  print(get_mort_file_name(year))
  
  mort <- read_mort_data(
    file_path = file.path(nchs_mort_dir, get_mort_file_name(year) ), 
    header = mort_header,
    n_max = Inf) %>% 
    glimpse() %>% 
    get_mort_filtered_by_icd(df_fips=fips, icd, by_race = TRUE)
  
  return(mort)
}
```

# pop 2016-2022 

```{r}
pop_all <- bind_rows(
  c(2016:2022) %>% 
    map(~process_pop_other(year = .))
  ) %>% 
  group_by(statecode, countycode, race) %>% 
  summarise(pop = sum(pop), .groups = "drop") %>% 
  filter(!(statecode == "02" & countycode == "261") ) %>% # remove 02261
  # remove 09001, 09003, ..., 09015
  filter(!(statecode == "09" & countycode %in% str_pad(as.character(seq(1, 15, 2)), 3, "left", "0") )) %>% 
  glimpse()
```

# use 2022 pop for new CT planning regions

- The new Connecticut counties only have 2022 population estimates. Their 7-year population is approximated by multiplying the 2022 value by 7. The state total uses actual annual estimates for each of the 7 years.

```{r}
pop_all_2 <- 
  update_pop_CT_new_sub61(pop_all, num_yrs = 7, state = FALSE) %>% # set state=FALSE if we want to keep CT state pop same as Census pop estimates, TRUE if we want fabricated CT state pop
  glimpse()
```

# NCHS mort data 

## header

```{r}
mort_header <- tribble(
  ~fld_name, ~start,  ~end,
  "state_of_residence", 29,  30,
  "county_of_residence", 35,  37,
  "icd_code", 146, 149,
  "hispanic_origin", 484, 486,
  "hispanic_origin_race_recode", 488, 488,
  "race_recode_40", 489, 490
)
```

## icd codes for v039

```{r}
icd_code_lst <- icd_codes_v039()

```

## mort 7 years
```{r}
mort_all <- bind_rows(
  c(2016:2022) %>% 
    map(~process_mort_other(year = ., icd_code_lst))
  ) %>%  
  group_by(statecode, countycode, race) %>%  
  summarise(deaths = sum(deaths), .groups = "drop") %>%  
  filter(!is.na(race)) 

```

# CT mort data for CT new counties

## import data 2016-2022

## import data 2016-2022

```{r}
CT_mort_2016to2022 <- read_csv(file.path(CT_mort_dir, "CT_mort_2016to2022.csv")) %>% 
  select(year = DTHYR, state = STRESIDF, countycode = CEPR_RES, age = Age_Years, icd_code = PCAUSE, RACE6_ETH, RACE6_ETH_label ) 
```

## CT mort data for new counties

```{r}
CT_mort_new <- 
  get_CT_from_CT_mort_sub61(CT_mort_2016to2022, year_lst = 2016:2022, icd_code_lst=icd_code_lst) %>% 
  filter(!is.na(race)) 

```

## update mort_all with only new CT counties or with both CT county and state data

```{r}
mort_all_2 <- 
  update_mort_CT_new_sub61(mort_all, CT_mort_new, state = FALSE) 
```

# mortality calculation

## merge mort and pop data

```{r}
merged <- pop_all_2 %>% 
  left_join(mort_all_2, 
            by = c("statecode", "countycode", "race"))
  
```


## confidence Intervals

```{r}
v039 <- merged %>% 
  rename(numerator = deaths, denominator = pop) %>% 
  mutate(
    rawvalue = numerator / denominator *100000,
    rse = 100 * sqrt(1/numerator),
  ) %>% 
  mutate(
    std = rawvalue * rse / 100,
    cilow = rawvalue - 1.96 * std,
    cihigh = rawvalue + 1.96 * std
  ) %>% 
  select(-c(rse, std)) 

```

## calculate CI L and U for n < 100

```{r}
suppress_limit <- 10

v039_2 <- v039 %>% 
  left_join(get_pois_CI(), by = c("numerator" = "n")) %>% 
  mutate(cilow = if_else(numerator>=suppress_limit & numerator <=99,
                         rawvalue * L, cilow),
         cihigh = if_else(numerator>=suppress_limit & numerator <=99,
                         rawvalue * U, cihigh)) %>% 
  select(-c(L, U)) %>% 
  mutate(across(c(denominator:cihigh), ~ if_else(numerator < suppress_limit, 
                                            NA_real_, .x))) 
```

## get subgroups

```{r}
v039_other <- process_race_data_wide(v039_2, fips, "v039") %>% 
  select(-c(ends_with('denominator'), ends_with('numerator')))

```

## add flag_CT

```{r}
v039_other_2 <- v039_other %>%
  add_flag_CT(vnum="v039_race", old = "U", new = "A")

```

# save data
```{r}
save_data(v039_other_2, "v039_otherdata")
```
