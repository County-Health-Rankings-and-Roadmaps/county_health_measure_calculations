---
title: "NCHS v161 Suicide - R2025"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

# about

## Basic information

- Description
Number of deaths due to suicide per 100,000 population (age-adjusted).

- What is the numerator?
The numerator is the number of deaths in a county over the five-year period due to suicide as defined by ICD-10 codes X60-X84 (self-harm).

- What is the denominator?
The denominator is the aggregate county population over the five-year period.

## Raw data access

- NCHS mortality and natality data 2018-2022: the data is requested

- Census population estimates 2018-2022 from:

2018 Census Population Estimates: https://www2.census.gov/programs-surveys/popest/datasets/2010-2018/counties/asrh/cc-est2018-alldata.csv

2019 Census Population Estimates: https://www2.census.gov/programs-surveys/popest/datasets/2010-2019/counties/asrh/cc-est2019-alldata.csv

2020 Census Population Estimates: https://www2.census.gov/programs-surveys/popest/datasets/2010-2020/counties/asrh/CC-EST2020-ALLDATA.csv

2021 Census Population Estimates: https://www2.census.gov/programs-surveys/popest/datasets/2020-2021/counties/asrh/cc-est2021-all.csv

2022 Census Population Estimates: https://www2.census.gov/programs-surveys/popest/datasets/2020-2022/counties/asrh/cc-est2022-all.csv

# import packages

```{r}
library(tidyverse)
library(haven)
```

# set up directory

```{r}
# set up directory that holds data needed for calculations
# NCHS mortality data, not allowed to share in GitHub
nchs_mort_dir <- "C:/01_CHRR/data/NCHS_2023-10-04/mort2016_2021"

# NCHS natality data, not allowed to share in GitHub
nchs_nata_dir <- "C:/01_CHRR/data/NCHS_2023-10-04/nat2016_2022"

# Census county population estimates data
census_pop_dir <- "C:/01_CHRR/data/Census_county_pop_est"
```

# standard county and state fips

- The final dataset will need to be aligned with standard FIPS codes and to include all counties and states.
```{r }
fips <-  bind_rows(
  read_sas("../inputs/county_fips_with_ct_old.sas7bdat"),
  read_sas( "../inputs/state_fips.sas7bdat")) %>% 
  arrange(statecode, countycode) %>% 
  glimpse()

```

# helpers

## functions used commonly by NCHS measures

- some commonly used functions are in a separate file, `nchs_measure_helpers.R`. 
```{r}
source("../scripts/nchs_measure_helpers.R")
```

## function: process pop data for v161

```{r}
process_pop_v161 <- function(year, by_race_TF = FALSE){
  pop <- read_census_pop(file_name = get_census_csv_file_info(year)$file_name ) %>% 
    get_census_pop_by_agecat_race(get_census_csv_file_info(year)$year_num, by_race = by_race_TF, age_cat_version = "v161")
  
  return(pop)
}
```

## function: process mort data for v161

```{r}
process_mort_v161 <- function(year, by_race_TF = FALSE, icd_v161 = NULL){
  
  print(get_mort_file_name(year))
  
  mort <- read_mort_data(
    file_path = file.path(nchs_mort_dir, get_mort_file_name(year) ), 
    header = mort_header,
    n_max = Inf) %>% 
    get_mort_data_by_agecat_race(df_fips=fips, by_race = by_race_TF, age_cat_version = "v161", icd_codes = icd_v161)
  
  return(mort)
}

```

# Pop data

## NCHS birth data: age_cat = 0

- Use births data to approximate infant population (age_cat = 0), as Census county-level population estimates use 5-year age groups and do not have age_cat = 0.

- The NCHS birth data was aggregated by state, county, age category, and race/ethnicity group.

```{r}
yrs <- c(2018:2022)

infant_pop <- 
  get_infant_pop(
    yrs, 
    file.path(nchs_nata_dir, "nchs_births_2014_2022.csv"), 
    by_race = FALSE) %>% 
  glimpse()

infant_pop
```

## Census pop data 2018-2022 by age cat 1-10

```{r}
pop_agecat_1_10 <- bind_rows(
  process_pop_v161(2018),
  process_pop_v161(2019),
  process_pop_v161(2020),
  process_pop_v161(2021),
  process_pop_v161(2022) %>% 
    fix_CT_pop(process_pop_v161(2021))
  ) %>% 
  group_by(statecode, countycode, age_cat) %>% 
  summarise(pop = sum(pop, na.rm = TRUE), .groups = "drop") %>% 
  glimpse()

pop_agecat_1_10
```

## combine age cat 0 with age cat 1-10

```{r}
pop_all <- 
  bind_rows(
    # age_cat = 2 to 10
    pop_agecat_1_10 %>% filter(age_cat!=1),
    
    # age_cat = 0
    fips %>% 
      select(1:2) %>% 
      left_join(infant_pop, by = c('statecode', 'countycode')) %>% 
      mutate(pop = if_else(is.na(pop), 0, pop)),
    
    # fixed age_cat = 1
    pop_agecat_1_10 %>% 
      filter(age_cat==1) %>% 
      bind_rows(infant_pop) %>% 
      pivot_wider(names_from = age_cat, values_from = pop, names_glue = "pop_{age_cat}") %>% 
      mutate(pop = if_else(is.na(pop_0), pop_1, pop_1 - pop_0)) %>% 
      select(-c(pop_0, pop_1)) %>% 
      mutate(age_cat = 1)
    ) %>% 
    arrange(statecode, countycode, age_cat) %>% 
    # set negative pop as 0; example: 15005
    mutate(pop = if_else(pop<0, 0, pop)) %>%
    filter(!(statecode == "02" & countycode == "261") )

pop_all  
```

```{r}
pop_all %>% 
  filter(pop < 0)

```


# mort data

## header

```{r}
mort_header <- tribble(
  ~fld_name, ~start,  ~end,
  "state_of_residence", 29,  30,
  "county_of_residence", 35,  37,
  "detail_age", 70, 73,
  "icd_code", 146, 149
)
```


## icd_code_lst for v161

```{r}
icd_code_lst <- c('X60', 'X61', 'X62', 'X63', 'X64', 'X65', 'X66', 'X67', 'X68', 
				    'X69','X70', 'X71', 'X72', 'X73', 'X74', 'X75', 'X76', 'X77', 
				    'X78', 'X79', 'X80', 'X81', 'X82', 'X83', 'X84')

```

## mort 2018-2022

```{r}
mort_all <- bind_rows(
  process_mort_v161(2018, icd_v161 = icd_code_lst), 
  process_mort_v161(2019, icd_v161 = icd_code_lst),
  process_mort_v161(2020, icd_v161 = icd_code_lst),
  process_mort_v161(2021, icd_v161 = icd_code_lst),
  process_mort_v161(2022, icd_v161 = icd_code_lst)
  ) %>% 
  group_by(statecode, countycode, age_cat) %>% 
  summarise(deaths = sum(deaths), .groups = "drop") %>% 
  glimpse()

mort_all %>% distinct(age_cat)
```

there's no case for age_cat 0 (infant) and 1 (1-4 age)

# mortality calculation

## merge mort and pop data

```{r}
merged <- pop_all %>% 
  left_join(mort_all, 
            by = c("statecode", "countycode", "age_cat")) %>% 
  glimpse()
  
```

## add weight for age adjustment

```{r}
wtd <- 274633642 # /*population 0 to 85+; Census 2000 model*/

merged_2 <- merged %>% 
  mutate(wtn = get_age_wtn(age_cat, version = "v161")) %>% 
  mutate(wt = wtn/wtd,
         age_adj=deaths/pop*wtn/wtd*100000,
         no_age_adj=deaths/pop*100000,
         wk_var = (wt**2)*((no_age_adj**2)/(deaths))) %>% 
  group_by(statecode, countycode) %>% 
  summarise(numerator = sum(deaths, na.rm = TRUE),
            denominator = sum(pop, na.rm = TRUE),
            rawvalue = sum(age_adj, na.rm = TRUE), 
            otherdata1 = sum(deaths, na.rm = TRUE)/sum(pop, na.rm = TRUE)*100000, # Crude rate per 100,000 population 
            # calculate std
            stdev = sqrt(sum(wk_var, na.rm = TRUE)),
            .groups = "drop") %>% 
  glimpse()
```

## confidence Intervals

```{r}
v161_1 <- merged_2 %>% 
  mutate(cilow = rawvalue - 1.96*stdev, 
         cihigh = rawvalue + 1.96*stdev,
         relative_standard_error = (stdev/rawvalue)) %>% 
  # select(-stdev) %>% 
  mutate(flag2 = if_else(relative_standard_error > 0.25, 
                         1, NA_real_)) %>% 
  mutate(flag2 = if_else(numerator < 10, 2, flag2)) %>% 
  mutate(across(c(numerator, denominator, rawvalue, cilow, cihigh), 
                ~ as.double(.x))) %>% 
  mutate(across(c(numerator, denominator, rawvalue, cilow, cihigh, otherdata1 ), 
                ~ if_else(!is.na(flag2) & flag2 == 2, 
                                            NA_real_, .x))) %>% 
  mutate(test_cb=round((rawvalue**2)/(stdev**2), digits = 0))

v161_1
```

## calculate CI L and U for n < 100

```{r}
v161_2 <- v161_1 %>% 
  left_join(get_pois_CI(), by = c("test_cb" = "n")) %>% 
  mutate(cilow = if_else(numerator>=10 & numerator <=99,
                         rawvalue * L, cilow),
         cihigh = if_else(numerator>=10 & numerator <=99,
                         rawvalue * U, cihigh)) %>% 
  select(-c(relative_standard_error, test_cb, L, U)) %>% 
  mutate(across(c(numerator, denominator, rawvalue, cilow, cihigh, otherdata1 ), 
                ~ if_else(!is.na(flag2) & flag2 == 2, 
                                            NA_real_, .x))) %>% 
  rename(ypll_se=stdev, flag2_cb = flag2) %>% 
  # fix se for 15005
  # mutate(ypll_se = if_else(statecode=="15" & countycode =="005",
  #                          NA_real_, ypll_se)) %>% 
  select(-c(ypll_se, flag2_cb)) %>% 
  mutate(sourceflag = NA_real_) %>% 
  rename_with(.fn = ~paste0("v161", "_", .x), .cols = c("denominator", "numerator", "rawvalue", "otherdata1", "cilow" , "cihigh", "sourceflag" ))

v161_2
```

# add flag_CT

- 'A' = data *available* for a CT county
- 'U' = data *unavailable* for a CT county

```{r}
v161_3 <- v161_2 %>% 
  add_flag_CT(vnum = "v161", old="A", new = "U")
```

# save data
```{r}
save_data(v161_3, "v161")
```

